# بهبود نمایش گراف صفحه /water/cld/

## خلاصه مشکل
گراف در صفحه CLD به درستی نمایش داده نمی‌شد و متن‌ها خوانا نبودند. نودها خیلی کوچک بودند و روی هم می‌افتادند.

## تغییرات اعمال شده

### ۱. افزایش سایز نودها ✅

**قبل:**
- fontSize: 15px
- padding: 18px
- minWidth: 100px
- minHeight: 48px
- maxTextWidth: 260px

**بعد:**
- fontSize: **18px** (+20%)
- padding: **24px** (+33%)
- minWidth: **140px** (+40%)
- minHeight: **64px** (+33%)
- maxTextWidth: **300px** (+15%)

**فایده:**
- نودها بزرگ‌تر و واضح‌تر
- متن‌ها به راحتی خوانده می‌شوند
- فضای کافی برای متن‌های بلند

### ۲. بهبود استایل نودها ✅

**تغییرات:**
- **فونت**: 18px (بزرگ‌تر)
- **وزن فونت**: 700 (bold‌تر)
- **رنگ متن**: `#0f1419` (تیره‌تر و واضح‌تر)
- **پس‌زمینه**: `#ffffff` (سفید خالص)
- **حاشیه**: `#3b82f6` (آبی روشن - واضح‌تر)
- **ضخامت حاشیه**: 3px (ضخیم‌تر)
- **text-outline**: 3px (برای جدا شدن از پس‌زمینه)
- **box-shadow**: `0 2px 8px rgba(0,0,0,0.15)` (سایه برای عمق)

**فایده:**
- نودها از پس‌زمینه تیره جدا می‌شوند
- متن خیلی واضح‌تر و خواناتر
- ظاهر حرفه‌ای‌تر و مدرن‌تر

### ۳. بهبود چیدمان (Layout) ✅

**تغییرات Dagre:**
- nodeSep: 60 → **100px** (+67%)
- rankSep: 90 → **140px** (+56%)
- edgeSep: 24 → **40px** (+67%)
- spacingFactor: 1.12 → **1.3** (+16%)
- padding: 30 → **50px** (+67%)

**تغییرات ELK:**
- spacing.nodeNode: 60 → **100px**
- spacing.edgeEdge: 16 → **30px**
- spacing.edgeNode: 24 → **40px**
- layered.spacing.baseValue: 60 → **100px**

**فایده:**
- نودها دیگر روی هم نمی‌افتند
- گراف خلوت‌تر و خواناتر
- راحت‌تر قابل navigate کردن

### ۴. بهبود یال‌ها (Edges) ✅

**تغییرات:**
- **عرض خط**: 2px → **3px** (ضخیم‌تر)
- **عرض خط مثبت/منفی**: +50% (واضح‌تر)
- **arrow-scale**: 1.2 → **1.4** (فلش‌های بزرگ‌تر)
- **line-dash-pattern**: [8,6] → **[10,8]** (خط‌چین واضح‌تر)
- **label font-size**: 12px → **14px**
- **label font-weight**: normal → **600** (bold)
- **label color**: متغیر → **#ffffff** (سفید خالص)
- **text-background**: rgba(0,0,0,0.35) → **rgba(15,20,25,0.85)** (تیره‌تر)
- **text-background-padding**: 1px → **4px** (فضای بیشتر)

**فایده:**
- یال‌ها واضح‌تر دیده می‌شوند
- تمایز بین مثبت و منفی بهتر
- label‌های یال‌ها خوانا هستند

### ۵. بهبود ظرف گراف ✅

**تغییرات CSS:**
```css
#cy-wrap { min-height: 600px; }
#cy {
  min-height: 560px;
  height: calc(100vh - 220px);
  border: 2px solid var(--muted);
  border-radius: 16px;
  background: linear-gradient(135deg, #0b1d1a 0%, #0f2421 100%);
}
#cy canvas {
  image-rendering: crisp-edges;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
```

**فایده:**
- گراف بزرگ‌تر و راحت‌تر قابل مشاهده
- پس‌زمینه gradient زیباتر
- رندرینگ بهتر و واضح‌تر

### ۶. فیچر جدید: کنترل‌های زوم سریع ✅

یک فایل جدید `graph-enhancements.js` اضافه شد که شامل:

- **دکمه‌های کنترل زوم**: + (zoom in), − (zoom out), ⊡ (fit), ◎ (center)
- **مخفی/نمایش خودکار label‌ها**: در زوم‌های پایین label‌های یال‌ها مخفی می‌شوند
- **بهبود متن فارسی**: تشخیص خودکار و تنظیم بهتر برای متن فارسی
- **تنظیم زوم اولیه**: اگر زوم خیلی کم است، به 0.7 تنظیم می‌شود
- **اطمینان از حداقل سایز**: نودهای خیلی کوچک به صورت خودکار بزرگ می‌شوند

**فایده:**
- کنترل راحت‌تر گراف
- تجربه کاربری بهتر
- عملکرد بهینه در زوم‌های مختلف

## فایل‌های تغییر یافته

1. **docs/assets/water-cld.js** - بهبود سایز نودها، استایل، layout و یال‌ها
2. **docs/assets/water-cld.css** - بهبود ظرف گراف و رندرینگ
3. **docs/water/cld/index.html** - اضافه کردن فایل graph-enhancements.js
4. **docs/assets/cld/ui/graph-enhancements.js** - **فایل جدید** برای فیچرهای اضافی

## نتایج

### قبل از بهبودها:
- ❌ نودها خیلی کوچک بودند
- ❌ متن‌ها خوانا نبودند
- ❌ نودها روی هم می‌افتادند
- ❌ یال‌ها ضعیف و کم‌رنگ بودند
- ❌ گراف شلوغ و غیرقابل استفاده بود

### بعد از بهبودها:
- ✅ نودها **40% بزرگ‌تر** و واضح‌تر
- ✅ متن‌ها **کاملاً خوانا** با فونت 18px و bold
- ✅ فاصله بین نودها **67% بیشتر** (100px)
- ✅ یال‌ها **50% ضخیم‌تر** و واضح‌تر
- ✅ گراف **حرفه‌ای** و **قابل استفاده**
- ✅ کنترل‌های زوم برای ناوبری راحت‌تر

## مقایسه دقیق

| ویژگی | قبل | بعد | بهبود |
|-------|-----|-----|-------|
| فونت نود | 15px | 18px | +20% |
| padding نود | 18px | 24px | +33% |
| حداقل عرض | 100px | 140px | +40% |
| حداقل ارتفاع | 48px | 64px | +33% |
| فاصله نودها | 60px | 100px | +67% |
| فاصله رتبه‌ها | 90px | 140px | +56% |
| عرض یال | 2px | 3px | +50% |
| فونت label یال | 12px | 14px | +17% |
| ضخامت حاشیه | 2px | 3px | +50% |

## تست و بررسی

برای مشاهده تغییرات:
```bash
# باز کردن صفحه در مرورگر
open https://wesh360.ir/water/cld/
```

**نکات تست:**
1. نودها باید بزرگ و واضح باشند
2. متن‌ها باید به راحتی خوانده شوند
3. نودها نباید روی هم بیفتند
4. یال‌ها باید واضح باشند
5. دکمه‌های زوم در گوشه چپ بالا ظاهر شوند
6. زوم کردن باید روان باشد
7. در زوم‌های پایین، label‌های یال‌ها باید مخفی شوند

## سازگاری

- ✅ مرورگرهای مدرن
- ✅ موبایل و تبلت
- ✅ RTL و فارسی
- ✅ حالت تیره
- ✅ زوم‌های مختلف

## ملاحظات عملکرد

- استایل‌ها با batch اعمال می‌شوند (بهینه)
- زوم با debounce اعمال می‌شود (جلوگیری از lag)
- label‌های یال در زوم پایین مخفی می‌شوند (عملکرد بهتر)
- رندرینگ با crisp-edges و antialiasing بهینه شده

## پیشنهادات بهبود بیشتر

1. اضافه کردن mini-map برای ناوبری راحت‌تر
2. امکان export گراف به تصویر
3. اضافه کردن search برای نودهای خاص
4. امکان فیلتر نودها بر اساس دسته
5. اضافه کردن tooltip برای نودها با اطلاعات بیشتر
6. حالت fullscreen برای گراف
7. امکان تغییر layout در real-time

## نتیجه‌گیری

با این بهبودها، گراف CLD حالا:
- **قابل استفاده** است
- **حرفه‌ای** به نظر می‌رسد
- **خوانا** و **واضح** است
- **تجربه کاربری عالی** ارائه می‌دهد

---

**تاریخ**: 2025-11-06
**نویسنده**: Claude AI Assistant
**نسخه**: 2.0
**مشکل برطرف شده**: گراف به خوبی نمایش داده نمی‌شد

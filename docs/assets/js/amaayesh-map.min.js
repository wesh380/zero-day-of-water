import{setClass as e}from"../css-classes.js";if(void 0!==window.L&&L.Icon&&L.Icon.Default){const e="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwsB9Yg7Q7MAAAAASUVORK5CYII=";L.Icon.Default.mergeOptions({iconUrl:e,iconRetinaUrl:e,shadowUrl:e}),console.log("[AMA] Leaflet default icon patched to blank PNG")}window.__AMA_BUILD_ID=document.querySelector('meta[name="build-id"]')?.content||String(Date.now());const n=window.AMA=window.AMA||{};function o(e,n={}){try{"function"==typeof window.gtag?window.gtag("event",e,n):"function"==typeof window.ga&&window.ga("send","event",e,n)}catch(e){window.AMA_DEBUG&&console.warn("[analytics]",e)}}n.G=n.G||{wind:L.layerGroup(),solar:L.layerGroup(),dams:L.layerGroup(),counties:L.layerGroup(),province:L.layerGroup()},window.__AMA_MAP=window.__AMA_MAP||null,n.flags=n.flags||{},n.flags.debugCountyMarker=!1,n.flags.disableMarkerIcons=!1;const t=!!n.flags.enableChoropleth;function a(e=""){return String(e).replace(/\u200c/g,"").replace(/[ÙŠ]/g,"ÛŒ").replace(/[Ùƒ]/g,"Ú©").replace(/\s+/g," ").trim().toLowerCase()}!function(){window.__AMA_UI_VERSION="dock-probe-v1",window.AMA_DEBUG&&console.log("[AMA:UI]",window.__AMA_UI_VERSION,"build=",window.__AMA_BUILD_ID,"path=",location.pathname);try{const n=document.createElement("div");n.id="ama-ui-probe",e(n,["debug-chip"]),n.textContent="AMA UI â€¢ "+window.__AMA_UI_VERSION,document.addEventListener("DOMContentLoaded",()=>document.body.appendChild(n)),setTimeout(()=>{const e=document.getElementById("ama-ui-probe");e&&e.remove()},3e3)}catch(e){}}(),window.__WIND_DATA_READY=window.__WIND_DATA_READY??!1,window.__WIND_WEIGHTS_MISSING=window.__WIND_WEIGHTS_MISSING??!1,window.__WIND_SELF_CHECK=window.__WIND_SELF_CHECK??{mapCount:0,hasData:0,noData:0,onlyInMap:[],onlyInIdx:[]},window.legend=window.legend||null,window.legendCtl=window.legendCtl||null,window.renderLegend=window.renderLegend||function(){},window.__AMA_renderTop10=window.__AMA_renderTop10||function(){};const i=(e,n)=>a(e)===a(n),r=["#f0f9ff","#e0f2fe","#bae6fd","#7dd3fc","#38bdf8","#0ea5e9","#0284c7","#0369a1","#075985"];function s(e){if(!e)return"sw-gray";const n=e.toLowerCase(),o=e=>{const n=e.replace("#","");return[parseInt(n.slice(0,2),16),parseInt(n.slice(2,4),16),parseInt(n.slice(4,6),16)]},[t,a,i]=o(n);let s=0,l=1/0;return r.forEach((e,n)=>{const[r,c,d]=o(e),u=(t-r)**2+(a-c)**2+(i-d)**2;u<l&&(l=u,s=n)}),`sw-${s}`}const l="Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ",c={"Ù…Ù‡ÙˆÙ„Ø§Øª":"Ù…Ù‡ ÙˆÙ„Ø§Øª","Ù…Ù‡â€ŒÙˆÙ„Ø§Øª":"Ù…Ù‡ ÙˆÙ„Ø§Øª","ØªØ±Ø¨ØªØ¬Ø§Ù…":"ØªØ±Ø¨Øª Ø¬Ø§Ù…","ØªØ±Ø¨Øªâ€ŒØ¬Ø§Ù…":"ØªØ±Ø¨Øª Ø¬Ø§Ù…","Ø·Ø±Ù‚Ø¨Ù‡ Ø´Ø§Ù†Ø¯ÛŒØ²":"Ø·Ø±Ù‚Ø¨Ù‡ Ùˆ Ø´Ø§Ù†Ø¯ÛŒØ²","Ø·Ø±Ù‚Ø¨Ù‡â€Œ Ø´Ø§Ù†Ø¯ÛŒØ²":"Ø·Ø±Ù‚Ø¨Ù‡ Ùˆ Ø´Ø§Ù†Ø¯ÛŒØ²","ÙÛŒØ¶ Ø¢Ø¨Ø§Ø¯":"Ù…Ù‡ ÙˆÙ„Ø§Øª","Ø·Ø±Ù‚Ø¨Ù‡":"Ø·Ø±Ù‚Ø¨Ù‡ Ùˆ Ø´Ø§Ù†Ø¯ÛŒØ²","Ø´Ø§Ù†Ø¯ÛŒØ²":"Ø·Ø±Ù‚Ø¨Ù‡ Ùˆ Ø´Ø§Ù†Ø¯ÛŒØ²","ØªØ±Ø¨ØªØ­ÛŒØ¯Ø±ÛŒÙ‡":"ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡","ØªØ±Ø¨Øªâ€ŒØ­ÛŒØ¯Ø±ÛŒÙ‡":"ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡","ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡":"ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡","ØªØ±Ø¨Øª-Ø­ÛŒØ¯Ø±ÛŒÙ‡":"ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡","ØªØ±Ø¨Øª Ø­ÙŠØ¯Ø±ÙŠÙ‡":"ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡","ØªØ±Ø¨Øªâ€ŒØ­ÙŠØ¯Ø±ÙŠÙ‡":"ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡","ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡â€Œ":"ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡"},d=Object.assign({},c||{},{"ØªØ±Ø¨ØªØ­ÛŒØ¯Ø±ÛŒÙ‡":"ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡","Ù…Ù‡ÙˆÙ„Ø§Øª":"Ù…Ù‡ ÙˆÙ„Ø§Øª","Ø²ÛŒØ±Ù†Ø¬ÙØ§Ù…":"Ø²Ø¨Ø±Ø®Ø§Ù†","Ø¨ÙŠÙ†Ø§Ù„ÙˆØ¯":"Ø¨ÛŒÙ†Ø§Ù„ÙˆØ¯"});function u(e=""){let n=(e||"").toString().replace(/[ÙŠÙ‰]/g,"ÛŒ").replace(/Ùƒ/g,"Ú©").replace(/[\u200c\u200f]/g,"").replace(/[Ù€]+/g,"").replace(/[-â€“â€”]+/g," ").replace(/\s+/g," ").trim();return"ØªØ±Ø¨ØªØ­ÛŒØ¯Ø±ÛŒÙ‡"===n&&(n="ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡"),/^Ù…Ù‡.?ÙˆÙ„Ø§Øª$/.test(n)&&(n="Ù…Ù‡ ÙˆÙ„Ø§Øª"),d[n]||n}function w(e={}){const n=["county","COUNTY","County","shahrestan","Shahrestan","Ø´Ù‡Ø±Ø³ØªØ§Ù†","Ù†Ø§Ù… Ø´Ù‡Ø±Ø³ØªØ§Ù†","Ù†Ø§Ù…_Ø´Ù‡Ø±Ø³ØªØ§Ù†","NAME","name","adm2name","ADM2_NAME","LABEL","label"];for(const o of n)if(null!=e[o]&&String(e[o]).trim())return u(String(e[o]));for(const[n,o]of Object.entries(e)){const e=String(o||""),n=e.match(/Ø¨Ø®Ø´\s*Ù…Ø±Ú©Ø²ÛŒ\s*Ø´Ù‡Ø±Ø³ØªØ§Ù†\s+(.+)$/);if(n)return u(n[1]);const t=e.match(/^Ø´Ù‡Ø±Ø³ØªØ§Ù†\s+(.+)$/);if(t)return u(t[1])}const o=Object.keys(e).find(e=>/name|label|Ø¹Ù†ÙˆØ§Ù†|Ù†Ø§Ù…/i.test(e));return o&&e[o]?u(String(e[o])):""}function _(n){try{const o=document.querySelector("#ama-map, .ama-map, .leaflet-container")||document.body;let t=document.getElementById("ama-toast");t||(t=document.createElement("div"),t.id="ama-toast",e(t,["toast"]),e(o,["relative"]),o.appendChild(t)),t.textContent=n,setTimeout(()=>{t&&t.parentNode&&t.parentNode.removeChild(t)},6e3)}catch(e){}}function p(e){if(!e)return e;if(/^https?:\/\//i.test(e))return e;return(e.startsWith("/")?e:"/data/"+e.replace(/^(\.\/)?/,"")).replace(/\/\/+/g,"/")}function f(e,n){const o=String(e||"").replace(/^\/+|\/+$/g,""),t=String(n||"").replace(/^\/+/,"");return o?`${o}/${t}`:t}function m(e){const o=window.AMA&&n.G||{},t=new Set(["province","counties","wind","solar","dams"]);Object.keys(o).forEach(n=>{const a=o[n];if(!a)return;const i=t.has(n),r=e.hasLayer(a);i&&!r&&(a.addTo(e),console.log(`[AMA] enforceDefaultVisibility added ${n} to map`)),!i&&r&&(e.removeLayer(a),console.log(`[AMA] enforceDefaultVisibility removed ${n} from map`))})}let A;function y(e,n){if(n&&(!n.__AMA_PROTECTED||n.__AMA_ALLOW_REPLACE)){try{e.hasLayer(n)&&e.removeLayer(n)}catch(o){console.warn("[AMA] Error removing layer, trying manual clear:",o.message);try{n.clearLayers&&"function"==typeof n.clearLayers&&n.clearLayers(),e.hasLayer(n)&&n.remove()}catch(e){console.error("[AMA] Failed to remove layer:",e)}}n.__AMA_ALLOW_REPLACE&&(n.__AMA_ALLOW_REPLACE=!1)}}function g(e,n){const o=e?.properties||{},t=o.name_fa||o.name||"â€”",a=o.county||o.shahrestan||o.admin2||"â€”",i=[];if("solar"===n){const e=o.capacity_mw??o.capacity??o.cap_mw,n=o.confidence??o.conf??o.cnf;null!=e&&i.push(`Ø¸Ø±ÙÛŒØª: ${e} MW`),null!=n&&i.push(`Ø§Ø·Ù…ÛŒÙ†Ø§Ù†: ${n}`)}else if("dam"===n){(!0===o.approx||"true"===o.approx)&&i.push('<span class="text-[10px] opacity-75">ØªÙ‚Ø±ÛŒØ¨ÛŒ</span>')}return`\n    <div class="ama-pop text-[12px] leading-5">\n      <div class="font-bold mb-1">${t}</div>\n      <div class="opacity-80">Ø´Ù‡Ø±Ø³ØªØ§Ù†: ${a}</div>\n      ${i.length?`<div class="mt-1">${i.join(" Â· ")}</div>`:""}\n    </div>`}function h(e,n){!function e(o){if(!o)return;if("function"==typeof o.getLayers)return void o.getLayers().forEach(e);const t=o.feature,a=t?.geometry?.type;"Polygon"!==a&&"MultiPolygon"!==a||n(o)}(e)}function M(e){if(!e)return[];const n=/,|;/,o=e.replace(/^\uFEFF/,"").split(/\r?\n/).filter(Boolean),t=o.shift().split(n).map(e=>e.trim()),a=[];for(const e of o){if(!e||!e.trim())continue;const o=e.split(n),i={};t.forEach((e,n)=>i[e]=(o[n]||"").trim()),a.push(i)}return a}function v(e){const n=e.properties||{},o=window.__activeWindKPI||"wind_wDensity",t=Number(n[o]??0);if(!!!n.__hasWindData)return{fillOpacity:.15,color:"#7a7a7a",weight:.8,dashArray:"3",fillColor:"#e5e7eb"};if(0===t)return{fillOpacity:.88,color:"#6b7280",weight:.9,fillColor:"#f3f4f6"};const a=window.__WIND_BREAKS||[.2,.4,.6,.8];let i=0;return t>a[0]&&(i=1),t>a[1]&&(i=2),t>a[2]&&(i=3),t>a[3]&&(i=4),{fillOpacity:.9,color:"#475569",weight:.9,fillColor:["#e0f2fe","#bae6fd","#7dd3fc","#38bdf8","#0ea5e9"][i]}}function E(){const e=document.getElementById("info");if(!e||!window.__weightsIdx)return;let n=0;h(window.__countiesLayer,e=>{(e.feature?.properties||{}).__hasWindData&&n++}),e.textContent=`Ø¯Ø§Ø¯Ù‡Ù” Ø¨Ø§Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ â€” ${Object.keys(window.__weightsIdx||{}).length} Ø±Ø¯ÛŒÙØŒ ${n} Ø´Ù‡Ø±Ø³ØªØ§Ù† Ø¯Ø§Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡`,e.classList.remove("text-slate-300"),e.classList.add("text-slate-400")}if(window.__AMA_BOOTING=window.__AMA_BOOTING||!1,window.__AMA_BOOTSTRAPPED=window.__AMA_BOOTSTRAPPED||!1,window.AMA_DEBUG=window.AMA_DEBUG||/(?:^|[?&])ama_debug=1\b/.test(location.search),window.__activeWindKPI=localStorage.getItem("ama-wind-metric")||"wind_wDensity",window.setActiveWindKPI=function(e){if(window.__activeWindKPI=e,localStorage.setItem("ama-wind-metric",e),window.__countiesLayer){const n=function(e,n,o=[.2,.4,.6,.8]){const t=[];if(!e)return null;if(h(e,e=>{const o=+((e.feature?.properties||{})[n]??0);Number.isFinite(o)&&o>0&&t.push(o)}),t.length<5)return null;t.sort((e,n)=>e-n);const a=e=>t[Math.floor(e*(t.length-1))];return o.map(a)}(window.__countiesLayer,e);n&&(window.__WIND_BREAKS=n),t&&h(window.__countiesLayer,e=>{e.feature&&e.setStyle(v(e.feature))})}"function"==typeof renderLegend&&renderLegend(),"function"==typeof __AMA_renderTop10&&__AMA_renderTop10(),E()},window.runWindSelfCheck=function(e){const n=!1!==e?.log;n&&window.AMA_DEBUG&&console.log("[AMA] self-check started");try{const e=[];let o=0,t=0;const i=new Set,r=new Set,s=new Set,l=(n,l)=>{const c=u(n?.county||n?.name_fa||n?.name||n?.NAME_2||n?.NAME_1||n?.shahrestan||n?.["Ù†Ø§Ù…"]||n?.["Ù†Ø§Ù…_Ø´Ù‡Ø±Ø³ØªØ§Ù†"]||""),d=a(c);if(!d||s.has(d))return;s.add(d),r.add(d);const w=!!n.__hasWindData;e.push({county:c,hasData:w,N:+(n.wind_N||0),sumW:+(n.wind_sumW||0),avgW:+(n.wind_avgW||0),_src:l}),i.add(d),w?o++:t++},c={countiesLayer:0,choropleth:0,boundary:0,polysFC:0,countiesGeo:0},d=[];window.__countiesLayer&&"function"==typeof window.__countiesLayer.eachLayer&&d.push(["countiesLayer",window.__countiesLayer]),window.windChoroplethLayer&&"function"==typeof window.windChoroplethLayer.eachLayer&&d.push(["choropleth",window.windChoroplethLayer]),window.boundary&&"function"==typeof window.boundary.eachLayer&&d.push(["boundary",window.boundary]),d.forEach(([e,n])=>{h(n,n=>{l((n.feature||{}).properties||{},e),c[e]++})}),window.polysFC?.features?.length&&window.polysFC.features.forEach(e=>{const n=e?.properties||{};if(void 0===n.__hasWindData){const e=+(n.wind_N||0),o=+(n.wind_sumW||0),t=+(n.wind_avgW||0);n.__hasWindData=e>0||o>0||t>0}l(n,"polysFC"),c.polysFC++}),window.countiesGeo?.features?.length&&window.countiesGeo.features.forEach(e=>{const n=e?.properties||{};if(void 0===n.__hasWindData){const e=+(n.wind_N||0),o=+(n.wind_sumW||0),t=+(n.wind_avgW||0);n.__hasWindData=e>0||o>0||t>0}l(n,"countiesGeo"),c.countiesGeo++});const w=new Set;window.__AMA_windIdx&&"object"==typeof window.__AMA_windIdx&&Object.keys(window.__AMA_windIdx).forEach(e=>w.add(a(u(e))));const _=[],p=[];r.size&&r.forEach(e=>{w.has(e)||_.push(e)}),w.size&&w.forEach(e=>{r.has(e)||p.push(e)});const f={mapCount:e.length,uniqueCountyCount:i.size,hasData:o,noData:t,onlyInMap:_,onlyInIdx:p,sourcesCount:c};window.__WIND_SELF_CHECK=f,window.__WIND_SELF_CHECK_ROWS=e,n&&window.AMA_DEBUG&&(console.group("WIND SELF-CHECK"),console.table(e.slice(0,12)),console.log("[AMA] summary",f),_.length&&console.warn("[AMA] onlyInMap",_.slice(0,20),"â€¦ total:",_.length),p.length&&console.warn("[AMA] onlyInIdx",p.slice(0,20),"â€¦ total:",p.length),console.groupEnd())}catch(e){window.AMA_DEBUG&&console.error("runWindSelfCheck",e)}return n&&window.AMA_DEBUG&&console.log("[AMA] self-check done"),window.__WIND_SELF_CHECK},window.__AMA_QA=function(){let e=0,n=[];window.__countiesLayer?(h(window.__countiesLayer,o=>{const t=o.feature?.properties||{};t.__hasWindData&&(e++,n.push({county:t.NAME||t.name||t.county,N:t.wind_N,MW:t.wind_sumW,d:t.wind_wDensity}))}),window.AMA_DEBUG&&(console.table(n.slice(0,10)),console.log("counties with wind data =",e))):console.warn("no counties layer")},window.AMA_DEBUG&&"function"==typeof window.fetch){const e=window.fetch;window.fetch=async function(...n){const o="string"==typeof n[0]?n[0]:n[0]?.url||"",t=performance.now();try{const a=await e.apply(this,n),i=Math.round(performance.now()-t);return console.log("[ama:fetch]",a.status,o,`${i}ms`),a}catch(e){const n=Math.round(performance.now()-t);throw console.warn("[ama:fetch-err]",o,e?.message,`${n}ms`),e}}}async function b(n){const r=window.__AMA_MAP,c=window.__AMA_canvasRenderer,d=window.AMA_DEBUG;let f="/data/";const m=new Map;async function b(e){let n=function(e){const n=f||"/data/",o=void 0!==window.__AMA_BUILD_ID?`?v=${window.__AMA_BUILD_ID}`:"",t=String(e||"").replace(/^\.\?\//,"");return new URL(t,location.origin+n).pathname+o}(e);if(n=p(n),m.has(n))return m.get(n);const o=await fetch(n);if(d&&console.log("[ama:data]","GET",n,"->",o.status),!o.ok)throw new Error("data-not-found: "+n);const t=await o.json();return m.set(n,t),t}window.AMA_DEBUG=d;window.supercluster;async function S(e){const n=void 0!==window.__AMA_BUILD_ID?`?v=${window.__AMA_BUILD_ID}`:"",o=f||"/data/",t=String(e||"").replace(/^\.?\//,""),a=new URL(t,location.origin+o).pathname+n,i=await fetch(a);if(d&&console.log("[ama:data:text] GET",a,"->",i.status),!i.ok)throw new Error("data-not-found: "+a);return await i.text()}const D=e=>e?.["name:fa"]||e?.["alt_name:fa"]||e?.name||"â€”";let I=null,N=null;function C(e){e&&!e.__AMA_PROTECTED&&e.clearLayers()}const T=(e,n=300)=>{let o;return(...t)=>{clearTimeout(o),o=setTimeout(()=>e(...t),n)}};let $=!1,k=null;window.__mapBounds||setTimeout(()=>{try{window.__mapBounds=r.getBounds()}catch{}},500),window.AMA_DEBUG&&r&&(r.on("zoomend",()=>console.log("[ama:event] zoomend =>",r.getZoom())),r.on("moveend",()=>console.log("[ama:event] moveend =>",r.getCenter())));let G=L.layerGroup().addTo(r),F=null,O=null,B=null,P=null,W=null;let U=null;function R(n){U&&U._div&&(U._div.innerHTML=n,e(U._div,[],["hidden"]))}function x(){U&&U._div&&(e(U._div,["hidden"]),U._div.innerHTML="")}U=L.control({position:"topleft"}),U.onAdd=function(e){const n=L.DomUtil.create("div","ama-infox info-popup hidden");return n.setAttribute("dir","rtl"),U._div=n},U.addTo(r);let j=window.__activeWindKPI||"wind_wDensity";const H={wind_N:"N",wind_sumW:"Î£w",wind_density:"N/kmÂ²",wind_wDensity:"Î£w/kmÂ²",wind_avgW:"avgW"};let Y=[];function z(e){let n=String(e).replace(/^\.\//,"").replace(/^\/+/,"");return n=n.replace(/^amaayesh\/data\//,"").replace(/^data\/amaayesh\//,"").replace(/^data\//,"").replace(/^amaayesh\//,""),n}let K=null;try{const{json:e,url:n}=await async function(){return window.__LAYER_MANIFEST_JSON&&window.__LAYER_MANIFEST_URL?{json:window.__LAYER_MANIFEST_JSON,url:window.__LAYER_MANIFEST_URL}:K||(K=async function(){const e=function(){const e=new URL(location.href),n=[new URL("./data/",e).pathname,new URL("../data/",e).pathname];return[...new Set(["/data/",...n,"/amaayesh/"])].map(e=>(e||"/").replace(/\/{2,}/g,"/").replace(/([^/])$/,"$1/"))}(),n=void 0!==window.__AMA_BUILD_ID?`?v=${window.__AMA_BUILD_ID}`:"";for(const o of e){const e=o+"layers.config.json"+n;try{const n=await fetch(e);if(d&&console.log("[ama:fetch]","GET",e,"->",n.status),n.ok){const o=await n.json();return d&&console.log("[ama:manifest] loaded from",e),{json:o,url:e}}}catch(n){d&&console.log("[ama:fetch]","ERR",e,n?.message)}}throw new Error("manifest-not-found")}(),K)}();!function(e){try{f=new URL(".",e).pathname.replace(/\/{2,}/g,"/"),d&&console.log("[ama:manifest] base",f)}catch{}}(n),window.__LAYER_MANIFEST=new Set((e.files||[]).map(z)),window.__LAYER_MANIFEST_URL=n,window.__LAYER_MANIFEST_JSON=e,window.AMA_DEBUG&&console.log("[AHA] manifest path used=",n),d&&console.log("[ama:manifest] using",n)}catch(e){window.showToast&&window.showToast("Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (layers.config.json)."),d&&console.warn(e)}function J(e){if(!e)return[];const n=["county","name_fa","name","NAME_2","NAME_1","shahrestan","Ù†Ø§Ù…","Ù†Ø§Ù…_Ø´Ù‡Ø±Ø³ØªØ§Ù†"],o=[];for(const t of n)null!=e[t]&&o.push(String(e[t]));return o}function V(e,n){return J(e).some(e=>a(e)===n)}async function q(e,n={}){if(!function(e){const n=window.__LAYER_MANIFEST;if(!(n instanceof Set))return!0;const o=z(e);return n.has(o)}(e))return window.AMA_DEBUG&&console.log("[ama-layer] skip (not in manifest):",e),null;let o=null;try{o=await b(e)}catch(n){return window.AMA_DEBUG&&console.warn("[ama-layer] missing or empty:",e),window.showToast&&_("Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: "+e),null}return o?.features?.length?L.geoJSON(o,n):(window.AMA_DEBUG&&console.warn("[ama-layer] missing or empty:",e),null)}async function Z(e,{layerKey:n,fallbacks:o=[]}={}){const t=Array.isArray(e)?e:[e];for(const e of[...t,...o])try{const n=await b(e);if(n)return n}catch(e){}return n&&function(e){const n=document.querySelector(`[data-layer-key="${e}"]`);n&&(n.disabled=!0,n.checked=!1,n.title="ÙØ§ÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø¯Ø± Ø§ÛŒÙ† Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª",n.closest("label")?.classList.add("is-disabled"))}(n),window.showToast&&_("Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: "+t[0]),window.AMA_DEBUG&&console.log("â›”ï¸ Dataset not found:",t[0],"â†’ tried:",t.concat(o)),null}window.__dumpAmaState=function(){const e=Array.isArray(window.__LAYER_MANIFEST)?window.__LAYER_MANIFEST:Array.from(window.__LAYER_MANIFEST||[]),n={manifestUrl:window.__LAYER_MANIFEST_URL,manifestSize:e.length,manifestSample:e.slice(0,5),inManifest:{"amaayesh/wind_sites.geojson":(o="amaayesh/wind_sites.geojson",e.includes(z(o)))},dataBase:"/data/amaayesh/",activeKPI:window.__activeWindKPI,hasCountyLayer:!!(window.__countiesLayer||window.windChoroplethLayer||window.boundary),polysFC_features:window.polysFC?.features?.length||0,countiesGeo_features:window.countiesGeo?.features?.length||0,countySource:window.__AMA_countySource||"unknown"};var o;return window.AMA_DEBUG&&console.log("[AMA] dump",n),n},window.__AMA_whereCounty=function(e){const n=a(e||"");let o=null,t=null;if(!o&&window.__countiesLayer&&"function"==typeof window.__countiesLayer.eachLayer&&h(window.__countiesLayer,e=>{const a=(e.feature||{}).properties||{};!o&&V(a,n)&&(o=a,t="__countiesLayer")}),!o&&window.windChoroplethLayer&&"function"==typeof window.windChoroplethLayer.eachLayer&&h(window.windChoroplethLayer,e=>{const a=(e.feature||{}).properties||{};!o&&V(a,n)&&(o=a,t="windChoroplethLayer")}),!o&&window.polysFC?.features?.length){const e=window.polysFC.features.find(e=>V((e||{}).properties||{},n));e&&(o=e.properties||null,t="polysFC")}if(!o&&window.countiesGeo?.features?.length){const e=window.countiesGeo.features.find(e=>V((e||{}).properties||{},n));e&&(o=e.properties||null,t="countiesGeo")}return window.AMA_DEBUG&&console.log("[AMA] whereCounty",e,"-> source:",t,"props:",o),o},window.__AMA_listCountyNames=function(){const e=new Set,n=[],o=(o,t)=>{const i=a(o||"");i&&!e.has(i)&&(e.add(i),n.push({name:o,source:t}))},t=(e,n)=>{e&&"function"==typeof e.eachLayer&&h(e,e=>{const t=(e.feature||{}).properties||{};for(const e of J(t))o(e,n)})};return t(window.__countiesLayer,"countiesLayer"),t(window.windChoroplethLayer,"choropleth"),window.polysFC?.features?.length&&window.polysFC.features.forEach(e=>J(e.properties||{}).forEach(e=>o(e,"polysFC"))),window.countiesGeo?.features?.length&&window.countiesGeo.features.forEach(e=>J(e.properties||{}).forEach(e=>o(e,"countiesGeo"))),window.AMA_DEBUG&&console.log("[AMA] county names",n.slice(0,20),"â€¦ total:",n.length),n},window.AMA_DEBUG&&window.__dumpAmaState();let Q=null;function X(){if(P)return;Q=document.createElement("div"),Q.id="ama-sp-overlay",Q.className="overlay hidden",document.body.appendChild(Q),Q.addEventListener("click",ee);const e=document.createElement("div");e.id="ama-sidepanel",e.className="ama-sidepanel map-panel",e.innerHTML='<header><h3 id="ama-sp-name"></h3><button class="close-btn" aria-label="Ø¨Ø³ØªÙ†">Ã—</button></header><div id="ama-sp-body"></div>',document.body.appendChild(e),P=e,e.querySelector(".close-btn").addEventListener("click",ee),document.addEventListener("keydown",e=>{"Escape"===e.key&&ee()})}function ee(){Q&&e(Q,["hidden"]),P?.classList.remove("open"),W&&(o("panel_close",{panel:W}),W=null)}function ne(n){if(P||X(),!P)return;const t=n.county||n.name||"â€”";W=t;const a=P.querySelector("#ama-sp-body"),s=`<div class="kpi-grid">\n        <div>N</div><div>${null!=n.wind_N?__AMA_fmtNumberFa(n.wind_N,{digits:0}):"â€”"}</div>\n        <div>Î£w</div><div>${null!=n.wind_sumW?__AMA_fmtNumberFa(n.wind_sumW,{digits:3}):"â€”"}</div>\n        <div>N/kmÂ²</div><div>${null!=n.wind_density?__AMA_fmtNumberFa(n.wind_density,{digits:3}):"â€”"}</div>\n        <div>Î£w/kmÂ²</div><div>${null!=n.wind_wDensity?__AMA_fmtNumberFa(n.wind_wDensity,{digits:3}):"â€”"}</div>\n        <div>avgW</div><div>${null!=n.wind_avgW?__AMA_fmtNumberFa(n.wind_avgW,{digits:3}):"â€”"}</div>\n      </div>`,l=(Y||[]).filter(e=>i(e.county,t)).slice(0,8),c=l.map(e=>`<li>${e.name_fa||"â€”"} <small>(${(+e.lon).toFixed(2)},${(+e.lat).toFixed(2)})</small> <span>${e.source||""}</span> <button data-lat="${e.lat}" data-lon="${e.lon}" data-name="${e.name_fa}">Ù†Ù…Ø§ÛŒØ´ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</button></li>`).join("");a.innerHTML=`${s}${l.length?`<div><b>Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ø´Ù‡Ø±Ø³ØªØ§Ù†:</b><ul class="sp-sites">${c}</ul></div>`:""}<div style="margin-top:8px"><button id="ama-sp-dl">Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV Ø´Ù‡Ø±Ø³ØªØ§Ù†</button></div>`,P.querySelector("#ama-sp-name").textContent=t,P.classList.add("open"),o("panel_open",{panel:t}),Q&&e(Q,[],["hidden"]);P.querySelector(".close-btn").focus(),P.onkeydown=e=>{if("Tab"===e.key){const n=P.querySelectorAll("button,a");if(!n.length)return;const o=n[0],t=n[n.length-1];e.shiftKey&&document.activeElement===o?(e.preventDefault(),t.focus()):e.shiftKey||document.activeElement!==t||(e.preventDefault(),o.focus())}},a.querySelectorAll("button[data-lat]").forEach(e=>{e.addEventListener("click",()=>{const n=+e.dataset.lat,o=+e.dataset.lon,t=e.dataset.name||"";C(G);L.marker([n,o]).addTo(G).bindPopup(t).openPopup(),r.setView([n,o],11)})});const d=a.querySelector("#ama-sp-dl");d&&d.addEventListener("click",()=>{const e="name_fa,lon,lat,source\n"+l.map(e=>`${e.name_fa},${e.lon},${e.lat},${e.source}`).join("\n");!function(e,n){const o=new Blob([n],{type:"text/csv"}),t=URL.createObjectURL(o),a=document.createElement("a");a.href=t,a.download=e,a.click(),setTimeout(()=>URL.revokeObjectURL(t),1e3)}(`${t}.csv`,e)})}function oe(e){let n=null;(windChoroplethLayer||A)?.eachLayer?.(o=>{i(o.feature?.properties?.county||"",e)&&(n=o)}),n&&(r.fitBounds(n.getBounds(),{maxZoom:11}),n.fire("click"),n.setStyle({weight:2}),setTimeout(()=>{B===n&&n.setStyle({weight:1.2})},800))}function te(e){if(!window.AMA_DEBUG)return;const n={};try{n.manifest_loaded=!(!window.__LAYER_MANIFEST||!window.__LAYER_MANIFEST.size)}catch(e){n.manifest_loaded=!1}try{n.manifest_files=window.__LAYER_MANIFEST?Array.from(window.__LAYER_MANIFEST):[]}catch(e){n.manifest_files=[]}try{n.counties_features=window.__AMA__combined?.features?.length||0}catch(e){n.counties_features=0}try{n.wind_sites_features=window.__AMA__windSitesFC?.features?.length||0}catch(e){n.wind_sites_features=0}try{n.boundary_layer=!!window.__AMA__boundary}catch(e){n.boundary_layer=!1}try{n.points_layer_present=!!window.windSitesLayer}catch(e){n.points_layer_present=!1}try{n.points_layer_on_map=n.points_layer_present&&e&&e.hasLayer(window.windSitesLayer)}catch(e){n.points_layer_on_map=!1}try{n.panes=e?Object.keys(e._panes||{}):[]}catch(e){n.panes=[]}try{n.zoom=e?e.getZoom():null}catch(e){n.zoom=null}console.group("%cAMA Â· Health","color:#0bf"),console.table(n),console.groupEnd()}window.__AMA_focusCountyByName=oe,(async()=>{await async function(){if(I)return;const e=window.__countiesGeoAll,n={type:"FeatureCollection",features:(e?.features||[]).filter(e=>{const n=e?.geometry?.type;return"Polygon"===n||"MultiPolygon"===n})};console.log(`[AMA] ensureAdminBase: filtered ${e?.features?.length||0} â†’ ${n.features.length} polygons`),I=L.featureGroup([],{pane:"polygons"}),I.__AMA_PROTECTED=!0,I.addTo(r),N=L.geoJSON(n,{pane:"polygons",renderer:c,pointToLayer:()=>null,style:{fillOpacity:.05,color:"#444",weight:.7}}),N.__AMA_PROTECTED=!0,I.addLayer(N),window.__AMA_COUNTIES_SOURCE=e,window.__countiesLayer=N,window.__AMA_countySource="preloaded all-counties",window.__countiesGeoAll=e,window.AMA_DEBUG&&console.log("[AHA] county source=preloaded"),window.AMA_DEBUG&&console.log("[AMA] base groups protected:",!!I,!!N?.__AMA_PROTECTED,!1)}();let o=window.__combinedGeo;if(!o?.features?.length)return;const a=n.wind,p=n.solar,f=n.dams,[m,b,P]=await Promise.all([a?Z(a,{layerKey:"wind_sites"}):Promise.resolve(null),p?Z(p,{layerKey:"solar"}):Promise.resolve(null),f?Z(f,{layerKey:"dams"}):Promise.resolve(null)]);m&&(O=m),f&&!P&&_("Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: "+f),p&&!b&&_("Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: "+p);const W={type:"FeatureCollection",features:[]},U={type:"FeatureCollection",features:[]};for(const _e of o.features){const pe=_e.geometry?.type;"Polygon"===pe||"MultiPolygon"===pe?W.features.push(_e):"Point"===pe&&U.features.push(_e)}const z={key:"solar",icon:"â˜€ï¸",title:"Ø¸Ø±ÙÛŒØª ØªØ¬Ù…ÛŒØ¹ÛŒ Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ",unit:"MW",type:"choropleth",period:"Û±Û´Û°Û³",method:"Jenks",classes:[{min:10,max:38,color:"#f3f4f6",label:"Û±Û°â€“Û³Û¸"},{min:38,max:74,color:"#e9d5ff",label:"Û³Û¸â€“Û·Û´"},{min:74,max:233,color:"#c4b5fd",label:"Û·Û´â€“Û²Û³Û³"},{min:233,max:774,color:"#8b5cf6",label:"Û²Û³Û³â€“Û·Û·Û´"},{min:774,max:1200,color:"#5b21b6",label:"Û·Û·Û´â€“Û±Û²Û°Û°"}],source:"Ø³Ø§ØªØ¨Ø§ (Ø¨Ø±Ø¢ÙˆØ±Ø¯ Ø§Ø³ØªØ§Ù†ÛŒ)",confidence:"Ù…ØªÙˆØ³Ø·",sub:"Ø¸Ø±ÙÛŒØª (MW) Â· Ø´ÙØ§ÙÛŒØª=Ø§Ø·Ù…ÛŒÙ†Ø§Ù†"},K=[],J=e=>{const n=z.classes.find(n=>e>=n.min&&e<=n.max);return n?n.color:"#f3f4f6"};L.geoJSON(W,{pane:"polygons",style:e=>({color:"#374151",weight:1,fillColor:J(e.properties.solar_mw),fillOpacity:.35,opacity:.7}),onEachFeature:(e,n)=>n.bindTooltip(D(e.properties),{sticky:!0,direction:"auto",className:"label"})}).eachLayer(e=>e.feature.properties.__legend_value=e.feature.properties.solar_mw);L.geoJSON(W,{pane:"polygons",style:e=>({fillColor:{1:"#bdbdbd",2:"#f6c945",3:"#29cc7a"}[e.properties.wind_class_num]||"#9e9e9e",fillOpacity:.35,color:"rgba(39,48,63,.4)",weight:.8}),onEachFeature:(e,n)=>n.bindTooltip(D(e.properties),{sticky:!0,direction:"auto",className:"label"})}).eachLayer(e=>e.feature.properties.__legend_value=e.feature.properties.wind_class_num);let V=null,Q=null,ae=null,ie=null;if(m&&(V=L.geoJSON(m,{pane:"points",pointToLayer:(e,n)=>L.circleMarker(n,{radius:6,weight:1})}),window.windSitesLayer=V),b&&(Q=L.geoJSON(b,{pane:"points",pointToLayer:(e,n)=>L.circleMarker(n,function(e){const n=e.properties||{},o=Number(n.capacity_mw??n.capacity??0),t=n.confidence;return{pane:"points",radius:o>=50?8:o>=10?6:4,fillOpacity:"number"==typeof t?Math.min(Math.max(t,0),1):"high"===t?.95:"med"===t?.75:.55,opacity:1,weight:1}}(e)),onEachFeature:(e,n)=>n.bindPopup(g(e,"solar"))}),window.solarSitesLayer=Q),P&&(ae=L.geoJSON(P,{pane:"points",pointToLayer:(e,n)=>L.circleMarker(n,{pane:"points",radius:6,fillOpacity:.85,opacity:1,weight:1}),onEachFeature:(e,n)=>n.bindPopup(g(e,"dam"))}),window.damsLayer=ae),K.push({key:"wind",icon:"ğŸŒ¬ï¸",title:"Ú©Ù„Ø§Ø³ Ø¨Ø§Ø¯ÛŒ",unit:"Ú©Ù„Ø§Ø³",type:"choropleth",classes:[{min:1,max:1,color:"#bdbdbd",label:"Ú©Ù„Ø§Ø³ Û±"},{min:2,max:2,color:"#f6c945",label:"Ú©Ù„Ø§Ø³ Û²"},{min:3,max:3,color:"#29cc7a",label:"Ú©Ù„Ø§Ø³ Û³"}],source:"Ø¬Ø¯ÙˆÙ„ Û¸",confidence:"Ù…ØªÙˆØ³Ø·",sub:"Ù…ØªØ±ÛŒÚ©: ØªØ±Ø§Ú©Ù… Ø¨Ø§Ø¯"}),K.push(z),ae&&K.push({key:"dams",icon:"ğŸŸ¦",title:"Ø³Ø¯Ù‡Ø§",type:"dams",classes:[{min:0,max:20,color:"#ef4444",label:"Û°â€“Û²Û°Ùª"},{min:20,max:40,color:"#fb923c",label:"Û²Û°â€“Û´Û°Ùª"},{min:40,max:60,color:"#f59e0b",label:"Û´Û°â€“Û¶Û°Ùª"},{min:60,max:80,color:"#84cc16",label:"Û¶Û°â€“Û¸Û°Ùª"},{min:80,max:100,color:"#22c55e",label:"Û¸Û°â€“Û±Û°Û°Ùª"}],samples:[{v:50,r:8},{v:200,r:14},{v:800,r:20}],source:"Ù¾Ø§ÛŒØ´ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¢Ø¨",confidence:"Ù¾Ø§ÛŒÛŒÙ†",sub:"ÙˆØ¶Ø¹ÛŒØª: Ø«Ø§Ø¨Øª/ÛŒÙˆÙ†ÛŒÙØ±Ù… (Ø¯Ø± Ù†Ø¨ÙˆØ¯ Ø¯Ø§Ø¯Ù‡Ù” Ù¾Ø±Ø´Ø¯Ú¯ÛŒ)"}),t){const fe=window.__countiesLayer,me=window.__AMA_COUNTIES_SOURCE;if(window.__AMA_countySource="none",F=me,window.countiesGeo=F,window.polysFC=me,me?.features?.length&&fe){function Ae(){B&&(ie.eachLayer(e=>e.setStyle(v(e.feature))),B=null),x(),ee()}X(),ie=L.geoJSON(me,{filter:e=>{const n=function(e={}){return u(e.ostan||e.province||e["Ù†Ø§Ù… Ø§Ø³ØªØ§Ù†"]||e["Ø§Ø³ØªØ§Ù†"]||e.ADM1_NAME||e.adm1name||"")}(e?.properties||{});return!n||n===l},pane:"polygons",style:e=>v(e),onEachFeature:(e,n)=>{n.bindTooltip("",{sticky:!0,direction:"auto",className:"label"}),n.on("tooltipopen",e=>{const n=e.target.feature?.properties||{},o=window.__activeWindKPI||"wind_wDensity",t=new Intl.NumberFormat("fa-IR",{maximumFractionDigits:2}),a="wind_wDensity"===o?"MW/kmÂ²":"wind_density"===o?"Ø³Ø§ÛŒØª/kmÂ²":"",i=t.format(n[o]||0),r=`${n.county||"â€”"}<br>${i} ${a}<br>ØªØ¹Ø¯Ø§Ø¯ Ø³Ø§ÛŒØª: ${t.format(n.wind_N||0)}<br>Ø¸Ø±ÙÛŒØª: ${t.format(n.wind_sumW||0)} MW`;e.tooltip.setContent(r)})}}),window.windChoroplethLayer=ie,window.AMA_DEBUG&&console.log("[AHA] overlays list=",Object.keys(k||{})),r.getPane("polygons")?.classList.add("ama-polygons"),ie.eachLayer(e=>{const n=e.getElement();n&&(n.setAttribute("tabindex","0"),n.addEventListener("keydown",n=>{"Enter"!==n.key&&" "!==n.key||e.fire("click")})),e.on("mouseover",()=>{const n=e.feature.properties||{};B!==e&&e.setStyle({...v(e.feature),color:"#22d3ee",weight:1.2,fillOpacity:.65});const o=n.county||n.name_fa||n.name||"â€”";n.__hasWindData?R(`<b>${o}</b><div>N: ${__AMA_fmtNumberFa(n.wind_N,{digits:0})}</div><div>Î£w: ${__AMA_fmtNumberFa(n.wind_sumW,{digits:3})}</div><div>N/kmÂ²: ${__AMA_fmtNumberFa(n.wind_density,{digits:3})}</div><div>Î£w/kmÂ²: ${__AMA_fmtNumberFa(n.wind_wDensity,{digits:3})}</div><div>avgW: ${__AMA_fmtNumberFa(n.wind_avgW,{digits:3})}</div>`):R(`<b>${o}</b><div>Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡</div>`)}),e.on("mouseout",()=>{B!==e&&e.setStyle(v(e.feature)),x()}),e.on("click",()=>{B=e,ie.eachLayer(e=>e.setStyle(v(e.feature))),e.setStyle({...v(e.feature),color:"#22d3ee",weight:1.2,fillOpacity:.75}),ne(e.feature.properties||{})})}),r.on("click",e=>{e.layer||Ae()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&Ae()});const ye=L.control({position:"topright"});ye.onAdd=function(){const e=L.DomUtil.create("div","ama-kpi-switch map-panel");return e.innerHTML=Object.entries(H).map(([e,n])=>`<label><input type="radio" name="ama-kpi" value="${e}" ${e===j?"checked":""}/><span class="chip">${n}</span></label>`).join(""),window.__WIND_DATA_READY||(e.classList.add("is-disabled"),e.title="Ø¯Ø§Ø¯Ù‡ Ø¨Ø§Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª"),L.DomEvent.disableClickPropagation(e),e.addEventListener("change",e=>{e.target&&e.target.value&&(j=e.target.value,window.setActiveWindKPI(j),r.fire("kpi:change",{kpi:window.__activeWindKPI}))}),e},ye.addTo(r);try{const ge=await S("amaayesh/wind_sites_raw.csv");Y=M(ge)}catch(he){Y=[]}window.__AMA_topPanel=L.control({position:"topright"}),window.__AMA_topPanel.onAdd=function(){const e=L.DomUtil.create("div","ama-panel map-panel");return e.innerHTML='<div class="ama-panel-hd">Top-10 Ø¨Ø§Ø¯</div><div class="ama-panel-bd"><div id="ama-top10"></div></div>',function(e,n){if(!e)return e;const o=`ama-panel:${n}`,t=e.querySelector(".ama-panel-hd");if(t){const n=document.createElement("button");n.type="button",n.className="toggle-btn";const a=()=>{n.textContent=e.classList.contains("ama-panel-collapsed")?"+":"âˆ’"};n.addEventListener("click",()=>{e.classList.toggle("ama-panel-collapsed");const n=!e.classList.contains("ama-panel-collapsed");localStorage.setItem(`${o}:open`,n?"1":"0"),a()}),t.appendChild(n),"0"===localStorage.getItem(`${o}:open`)&&e.classList.add("ama-panel-collapsed"),a()}const a=document.createElement("div");a.className="ama-panel-resize-handle",e.appendChild(a);const i=`${o}:h`,r=parseInt(localStorage.getItem(i),10);r&&e.setAttribute("style",`height:${r}px`);let s=0,l=0;const c=n=>{s=n.touches?n.touches[0].clientY:n.clientY,l=e.offsetHeight;const o=window.__AMA_MAP;if(o)try{o.dragging.disable(),o.scrollWheelZoom.disable()}catch(e){}document.addEventListener("mousemove",d),document.addEventListener("touchmove",d),document.addEventListener("mouseup",u),document.addEventListener("touchend",u),n.preventDefault()},d=n=>{const o=n.touches?n.touches[0].clientY:n.clientY,t=Math.max(80,l+(o-s));e.setAttribute("style",`height:${t}px`)},u=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("touchmove",d),document.removeEventListener("mouseup",u),document.removeEventListener("touchend",u);const n=window.__AMA_MAP;if(n)try{n.dragging.enable(),n.scrollWheelZoom.enable()}catch(e){}const o=parseInt(getComputedStyle(e).height,10)||e.offsetHeight;localStorage.setItem(i,o)};return a.addEventListener("mousedown",c),a.addEventListener("touchstart",c),e}(e,"top10")},window.__AMA_renderTop10=T(function(){const n=document.getElementById("ama-top10"),o=n?n.closest(".ama-panel"):null;if(!o||!n)return;if(window.__WIND_WEIGHTS_MISSING)return void e(o,["hidden"]);if(e(o,[],["hidden"]),!window.__WIND_DATA_READY)return void(n.innerHTML='<div class="ama-loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>');const t=me.features.map(e=>e.properties).filter(e=>e.__hasWindData);t.sort((e,n)=>(n[j]||0)-(e[j]||0));const a=t.slice(0,10);n.innerHTML=a.map((e,n)=>`<div class="ama-row" data-county="${e.county||""}"><div class="c">${__AMA_fmtNumberFa(n+1)}</div><div class="n">${e.county||"â€”"}</div><div class="m">${__AMA_fmtNumberFa(e[j]||0,{digits:3})}</div></div>`).join(""),n.querySelectorAll(".ama-row").forEach(e=>{e.addEventListener("click",()=>{const n=e.getAttribute("data-county");oe(n),ne(me.features.find(e=>i(e.properties.county,n))?.properties||{})})})},300),window.__AMA_topPanel.addTo(r),window.__AMA_renderTop10(),window.__AMA_kpiLegend=L.control({position:"topright"}),window.__AMA_kpiLegend.onAdd=function(){const e=L.DomUtil.create("div","ama-panel map-panel");return L.DomUtil.create("div","ama-kpi-legend",e).id="ama-kpi-legend",e},window.__AMA_kpiLegend.addTo(r),window.renderLegend=T(function(){const e=document.getElementById("ama-kpi-legend");if(!e)return;if(!window.__WIND_DATA_READY)return void(e.innerHTML='<div class="ama-loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>');const n=new Intl.NumberFormat("fa-IR",{maximumFractionDigits:2}),o=["#e0f2fe","#bae6fd","#7dd3fc","#38bdf8","#0ea5e9"],t=window.__WIND_BREAKS||[.2,.4,.6,.8],a=[`â‰¤${n.format(t[0])}`,`${n.format(t[0])}â€“${n.format(t[1])}`,`${n.format(t[1])}â€“${n.format(t[2])}`,`${n.format(t[2])}â€“${n.format(t[3])}`,`>${n.format(t[3])}`];let i='<div class="lg"><span class="sw sw-gray"></span>Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡</div>';for(let e=0;e<a.length;e++)i+=`<div class="lg"><span class="sw ${s(o[e])}"></span>${a[e]}</div>`;e.innerHTML=i},300),window.renderLegend(),r.on("kpi:change",()=>{window.__countiesLayer&&(h(window.__countiesLayer,e=>{e.feature.properties.__legend_value=e.feature.properties[j],e.setStyle(v(e.feature))}),B&&B.setStyle({...v(B.feature),color:"#22d3ee",weight:1.2,fillOpacity:.75})),window.__AMA_renderTop10?.(),window.renderLegend?.()}),async function(){let e="";try{e=await S("amaayesh/wind_weights_by_county.csv")}catch(e){return window.__WIND_WEIGHTS_MISSING=!0,void(d&&console.warn("[join] CSV missing"))}const n=M(e),o={};for(const e of n){const n=u(e.county);n&&(o[n]={n_sites:+e.n_sites||0,sum_w:+e.sum_w||0,area_km2:+e.area_km2||0,sites:e.sites||"",wind_class:e.wind_class||""})}window.__weightsIdx=o;try{window.__AMA_windIdx=o}catch(e){}if(!window.__countiesLayer)return void(d&&console.warn("[join] no counties layer"));window.AMA_DEBUG&&function(){const e=Object.keys(window.__weightsIdx||{}),n=new Set;let o=0;h(window.__countiesLayer,e=>{o++;const t=w(e.feature?.properties||{});t&&n.add(t)});const t=e.filter(e=>!n.has(e)),a=[...n].filter(e=>!(window.__weightsIdx||{})[e]);console.group("[wind join]"),console.log("CSV count:",e.length,"Map count (processed):",o,"Unique county names:",n.size),t.length?(console.error("Only in CSV (no polygon match):",t),console.error("âŒ join QA (subset) failed.")):(a.length&&console.info("Only in Map (no CSV row):",a),console.log("âœ… join QA (subset) passed.")),console.groupEnd()}(),h(window.__countiesLayer,e=>{const n=e.feature?.properties||{},o=w(n),a=window.__weightsIdx[o]||{};let i=+n.area_km2||0;!i&&+a.area_km2&&(i=+a.area_km2),n.wind_N=+a.n_sites||0,n.wind_sumW=+a.sum_w||0,n.wind_avgW=n.wind_N?n.wind_sumW/n.wind_N:0,n.wind_density=i?n.wind_N/i:0,n.wind_wDensity=i?n.wind_sumW/i:0,n.wind_sites=a.sites||"",n.wind_class=a.wind_class||"",n.__hasWindData=n.wind_N>0||n.wind_sumW>0,t&&e.setStyle(v(e.feature))}),window.__WIND_DATA_READY=!0;const a=window.__activeWindKPI||"wind_wDensity",i=function(e,n,o=[.2,.4,.6,.8]){const t=[];return h(e,e=>{const o=+((e.feature?.properties||{})[n]??0);Number.isFinite(o)&&o>0&&t.push(o)}),t.length<5?null:(t.sort((e,n)=>e-n),o.map(e=>t[Math.floor(e*(t.length-1))]))}(window.__countiesLayer,a);i&&(window.__WIND_BREAKS=i),"function"==typeof renderLegend&&renderLegend(),"function"==typeof __AMA_renderTop10&&__AMA_renderTop10(),E()}().then(()=>{const e=ye.getContainer?ye.getContainer():null;e&&(e.classList.remove("is-disabled"),e.removeAttribute("title")),setActiveWindKPI(window.__activeWindKPI||"wind_wDensity"),r.fire("kpi:change",{kpi:window.__activeWindKPI||"wind_wDensity"})})}else{const Le=document.getElementById("info");Le&&(Le.textContent="Ø¯Ø§Ø¯Ù‡ Ø´Ù‡Ø±Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.")}}let re=null;window.__LAYER_MANIFEST?.has("electricity_lines.geojson")&&(re=await q("electricity_lines.geojson",{style:e=>({color:"#22c55e",weight:2})}));let se=null;window.__LAYER_MANIFEST?.has("water_mains.geojson")&&(se=await q("water_mains.geojson",{style:e=>({color:"#3b82f6",weight:2})}));let le=null;window.__LAYER_MANIFEST?.has("gas_transmission.geojson")&&(le=await q("gas_transmission.geojson",{style:e=>({color:"#f59e0b",weight:2})}));let ce=null;function de(){const e=r.getZoom()>=8;[V,Q,ae].forEach(n=>{n&&!e&&r.hasLayer(n)&&y(r,n)})}window.__LAYER_MANIFEST?.has("oil_pipelines.geojson")&&(ce=await q("oil_pipelines.geojson",{style:e=>({color:"#ef4444",weight:2})})),r.on("zoomend",de),k={},V&&(k["Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø¯ÛŒ (Ø¨Ø±Ø¢ÙˆØ±Ø¯ÛŒ)"]=V),Q&&(k["Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ±Ø´ÛŒØ¯ÛŒ"]=Q),ae&&(k["Ø³Ø¯Ù‡Ø§"]=ae);Object.entries(k);if(de(),$=!0,window.AMA_DEBUG&&console.log("[AHA] overlays list =",Object.keys(k)),window.AMA_DEBUG&&console.log("[AMA] base groups:",!!I),window.AMA_DEBUG&&console.log("[AHA] baseData:",a,p,f),L.control.scale({metric:!0,imperial:!1}).addTo(r),L.Control&&L.Control.geocoder){L.Control.geocoder({defaultMarkGeocode:!1}).addTo(r).on("markgeocode",e=>{const n=e.geocode.center,o=e.geocode.name;C(G),G.addLayer(L.circleMarker(n,{radius:7,color:"#22d3ee",weight:2,fillColor:"#22d3ee",fillOpacity:1}).bindTooltip(o,{direction:"top",offset:[0,-10]})),e.geocode.bbox?r.fitBounds(e.geocode.bbox):r.setView(n,14)})}const ue=le,we=L.layerGroup();if(ue){const Me=L.geoJSON(ue.toGeoJSON(),{style:{color:"#ffe0d6",weight:8,opacity:1}});if(we.addLayer(Me),ue.bringToFront(),L&&L.polylineDecorator&&L.Symbol&&L.Symbol.arrowHead&&we.addLayer(L.polylineDecorator(ue,{patterns:[{offset:0,repeat:"80px",symbol:L.Symbol.arrowHead({pixelSize:8,pathOptions:{color:"#ef476f",weight:1}})}]})),"undefined"!=typeof turf)try{const ve=ue.toGeoJSON().features.reduce((e,n)=>e?turf.union(e,n):n,null);let Ee=null;[10,30,50].forEach((e,n)=>{const o=turf.buffer(ve,e,{units:"kilometers"}),t=Ee?turf.difference(o,Ee):o;Ee=o,t&&we.addLayer(L.geoJSON(t,{style:{fillColor:"#ffd0cc",fillOpacity:.25,color:"#e06b5f",weight:1}}))})}catch(be){}r.hasLayer(ue)&&we.addTo(r),r.on("layeradd",e=>{e.layer===ue&&we.addTo(r)}),r.on("layerremove",e=>{e.layer===ue&&y(r,we)})}window.__AMA__combined=o,window.__AMA__windSitesFC=O||{},window.__AMA__boundary=null,te(r),r.on("layeradd",e=>{e.layer!==A&&e.layer!==window.windSitesLayer&&e.layer!==window.windChoroplethLayer||te(r)}),document.getElementById("info").innerHTML="Ù‡Ù…Ù‡â€ŒÛŒ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯."})().catch(()=>{}),window.__amaHealthReport=te,window.__AMA_fmtNumberFa=function(e,{digits:n=0}={}){const o=(isFinite(+e)?(+e).toFixed(n):"0").split(".");return o[0]=o[0].replace(/\B(?=(\d{3})+(?!\d))/g,"Ù¬"),t=o.join(o[1]?"Ù«":""),String(t).replace(/[0-9]/g,e=>"Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[+e]);var t}}window.addEventListener("unhandledrejection",e=>{const n=e?.reason?.message||e?.reason||"";/message channel closed/i.test(String(n))&&(window.AMA_DEBUG&&console.warn("[ama-ignore-ext]",n),e.preventDefault())}),window.addEventListener("error",e=>{const n=e?.message||e?.error?.message||"";/message channel closed/i.test(String(n))&&(window.AMA_DEBUG&&console.warn("[ama-ignore-ext]",n),e.preventDefault())}),async function(){if(window.__AMA_BOOTSTRAPPED||window.__AMA_BOOTING)return;window.__AMA_BOOTING=!0;const t=performance.now?performance.now():Date.now();await new Promise(e=>{"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})});const a=p("layers.config.json")+"?v="+(window.__BUILD_ID||Date.now()),i="/amaayesh/layers.config.json?v="+(window.__BUILD_ID||Date.now());let r=a;window.AMA_DEBUG&&console.log("[AMA] manifest path",r);let s=await fetch(a).then(e=>e.ok?e.json():null).catch(e=>null);s||(r=i,s=await fetch(i).then(e=>e.ok?e.json():null).catch(e=>null));const l=function(e){const n=e&&e.baseData||"",o=e&&e.layers||{},t=o.province||o.combined||"khorasan_razavi_combined.geojson";return{counties:"string"==typeof o.counties&&""!==o.counties.trim()?f(n,o.counties):null,province:f(n,t),wind:f(n,o.wind_sites||"wind_sites.geojson"),solar:f(n,o.solar_sites||"solar_sites.geojson"),dams:f(n,o.dams||"dams.geojson")}}(s);async function c(e){return e?await async function(e,n=3e4){const o=`/data/${String(e).replace(/^\/+/,"")}`,t=`/${String(e).replace(/^\/+/,"")}`;async function a(e){const o=new AbortController,t=setTimeout(()=>o.abort(),n);try{const n=await fetch(e,{signal:o.signal});if(!n.ok)throw new Error(`HTTP ${n.status}`);const t=(n.headers.get("content-type")||"").toLowerCase(),a=await n.text();if(t.includes("html")||a.trim().startsWith("<!DOCTYPE"))throw new Error("not-json");return JSON.parse(a)}finally{clearTimeout(t)}}try{return await a(o)}catch(n){console.warn("[AHA] primary failed:",o,n.message,"â†’ trying legacy",t);try{return await a(t)}catch(n){return console.error("[AHA] fetch fail:",e,n.message),null}}}(e):null}console.log("[AMA] manifest loaded:",s),console.log("[AMA] paths resolved:",l),window.__LAYER_MANIFEST_JSON=s,window.__LAYER_MANIFEST_URL=r,window.__AMA_BASE_PATHS=l;const[d,u,w,_]=await Promise.all([c(l.counties),c(l.wind),c(l.solar),c(l.dams)]);let A=null;!d&&l.province?(console.log("[AMA] counties not found, loading province as fallback..."),A=await c(l.province)):d&&console.log("[AMA] counties loaded, province will be lazy-loaded on demand");const y=(e,n)=>{if(!e||!e.features)return{total:0,polygons:0,points:0,other:0};const o={total:e.features.length,polygons:0,points:0,other:0};return e.features.forEach(e=>{const n=e?.geometry?.type;"Polygon"===n||"MultiPolygon"===n?o.polygons++:"Point"===n?o.points++:o.other++}),console.log(`[AMA] ${n}:`,o),o};y(d,"counties"),y(A,"province"),y(u,"wind"),y(w,"solar"),y(_,"dams"),console.log("[AMA] Data loaded:",{countiesFC:d?`${d.features?.length||0} features`:"null",provinceFC:A?`${A.features?.length||0} features`:"null",windFC:u?`${u.features?.length||0} features`:"null",solarFC:w?`${w.features?.length||0} features`:"null",damsFC:_?`${_.features?.length||0} features`:"null"});let g=d;function h(e,n){return e?L.geoJSON(e,{pane:"points",filter:e=>{const n=e?.geometry?.type;return"Point"===n},pointToLayer:(e,o)=>{try{const t=function(e){const n={wind:"ğŸ’¨",solar:"â˜€ï¸",dams:"ğŸ’§"},o={wind:"#38bdf8",solar:"#fbbf24",dams:"#60a5fa"};if(!n[e])return console.warn(`[AMA] Unknown icon type: ${e}, using default`),L.divIcon({className:"custom-marker marker-default",html:'\n          <div class="marker-container">\n            <div class="marker-icon" style="color: #38bdf8">ğŸ“</div>\n            <div class="marker-pulse" style="background: #38bdf833"></div>\n          </div>\n        ',iconSize:[36,36],iconAnchor:[18,36],popupAnchor:[0,-36]});try{return L.divIcon({className:`custom-marker marker-${e}`,html:`\n          <div class="marker-container">\n            <div class="marker-icon" style="color: ${o[e]}">${n[e]}</div>\n            <div class="marker-pulse" style="background: ${o[e]}33"></div>\n          </div>\n        `,iconSize:[36,36],iconAnchor:[18,36],popupAnchor:[0,-36]})}catch(e){return console.error("[AMA] Error creating DivIcon:",e),null}}(n);if(!t)return console.error(`[AMA] Failed to create icon for ${n}`),null;const a=L.marker(o,{icon:t}),i=e.properties||{},r=`\n            <div class="custom-popup" dir="rtl">\n              <h3>${i.name_fa||i.name||"Ù†Ø§Ù… Ù†Ø§Ù…Ø´Ø®Øµ"}</h3>\n              <p><strong>Ø´Ù‡Ø±Ø³ØªØ§Ù†:</strong> ${i.county||"-"}</p>\n              ${i.capacity_mw?`<p><strong>Ø¸Ø±ÙÛŒØª:</strong> ${i.capacity_mw} Ù…Ú¯Ø§ÙˆØ§Øª</p>`:""}\n              ${i.wind_class?`<p><strong>Ú©Ù„Ø§Ø³ Ø¨Ø§Ø¯:</strong> ${i.wind_class}</p>`:""}\n            </div>\n          `;return a.bindPopup(r),a}catch(e){return console.error(`[AMA] Error creating marker for ${n}:`,e),null}}}):null}function M(e,o){const t=n.G[e];if(!t)return;t.clearLayers();const a=h(o,e);a&&t.addLayer(a)}function v(e,o){if(!o)return;const t={type:"FeatureCollection",features:(o.features||[]).filter(e=>{const n=e?.geometry?.type;return"Polygon"===n||"MultiPolygon"===n})},a="province"===e?{color:"#ef4444",weight:5,opacity:1,fillOpacity:.03,fillColor:"#ef444410",fill:!0,className:"province-border",interactive:!1}:{color:"#94a3b8",weight:2,opacity:.8,fillOpacity:0,fill:!1,className:"county-border",interactive:!1},i=L.geoJSON(t,{pane:"polygons",pointToLayer:()=>null,style:()=>a,onEachFeature:(e,n)=>{if(e.properties){const o=e.properties.name_fa||e.properties.name||e.properties.NAME||"";o&&n.bindTooltip(o,{permanent:!1,direction:"center",className:"polygon-tooltip"})}}});n.G[e].clearLayers(),n.G[e].addLayer(i),console.log(`[AMA] Added ${e} polygroup - ${t.features.length} polygons from ${o.features?.length||0} total features`)}!d&&A?(console.warn("[AMA] counties is null, using provinceFC as fallback"),g=A,window.__countiesGeoAll=A):window.__countiesGeoAll=d||{type:"FeatureCollection",features:[]},window.__combinedGeo=A,console.log("[AHA] all-counties.features =",(window.__countiesGeoAll?.features||[]).length);const E=window.__AMA_MAP||n.map||L.map("map",{preferCanvas:!0,zoomControl:!0,tap:!0,tapTolerance:15,touchZoom:!0,bounceAtZoomLimits:!1,zoomSnap:.5,wheelPxPerZoomLevel:120,tapHold:!0,touchExtend:!0});window.__AMA_MAP=E;const S=document.getElementById("map");if(S){const e=S.getBoundingClientRect();console.log("[AMA] Map container dimensions:",{width:e.width,height:e.height,display:getComputedStyle(S).display,visibility:getComputedStyle(S).visibility}),0!==e.width&&0!==e.height||console.error("[AMA] âŒ Map container has ZERO dimensions! Check CSS!")}else console.error("[AMA] âŒ Map container #map not found!");if(E.createPane("boundary"),e(E.getPane("boundary"),["z-400"]),E.createPane("polygons"),e(E.getPane("polygons"),["z-500"]),E.createPane("points"),e(E.getPane("points"),["z-600"]),console.log("[AMA] Panes created:",{boundary:!!E.getPane("boundary"),polygons:!!E.getPane("polygons"),points:!!E.getPane("points")}),v("counties",g),v("province",A),M("wind",u),M("solar",w),M("dams",_),!A&&l.province){let e=!1;E.on("zoomend",async function(){if(E.getZoom()<10&&!e){e=!0,console.log("[AMA] ğŸ—ºï¸ Zoom < 10 detected, lazy-loading province boundary (4.1MB)...");try{const e=await c(l.province);e&&(v("province",e),console.log("[AMA] âœ… Province boundary loaded and added to map"))}catch(e){console.error("[AMA] âŒ Failed to lazy-load province:",e)}}}),console.log("[AMA] ğŸ“ Province lazy-loader registered (will load on zoom < 10)")}console.log("[AMA] Groups populated:",{counties:n.G.counties?.getLayers().length||0,province:n.G.province?.getLayers().length||0,wind:n.G.wind?.getLayers().length||0,solar:n.G.solar?.getLayers().length||0,dams:n.G.dams?.getLayers().length||0});const D=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap",maxZoom:19,errorTileUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mN8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=="});D.on("tileerror",function(e,n){console.warn("[AMA] Tile load error:",e)}),D.addTo(E),console.log("[AMA] Tile layer added to map"),E.zoomControl&&"function"==typeof E.zoomControl.setPosition&&E.zoomControl.setPosition("bottomleft"),E.attributionControl&&"function"==typeof E.attributionControl.setPosition&&E.attributionControl.setPosition("bottomleft"),E.setView([36.3,59.6],7),E.on("click",e=>{o("map_click",{lat:e.latlng.lat,lng:e.latlng.lng})}),window.AMA_DEBUG&&console.log("[AHA] panes zIndex=",{polygons:getComputedStyle(E.getPane("polygons")).zIndex,points:getComputedStyle(E.getPane("points")).zIndex,boundary:getComputedStyle(E.getPane("boundary")).zIndex});const I=L.canvas({padding:.5});window.__AMA_canvasRenderer=I;const N=E.removeLayer.bind(E);E.removeLayer=e=>{if(e?.__AMA_PROTECTED&&!e.__AMA_ALLOW_REPLACE)return window.AMA_DEBUG&&console.warn("[AMA] blocked remove on protected layer"),E;try{return N(e)}catch(n){console.warn("[AMA] Error in map.removeLayer:",n.message);try{e&&e.remove&&e.remove()}catch(e){console.error("[AMA] Failed manual remove:",e)}return E}},console.log("[AMA] â•â•â•â•â•â• CREATING BOUNDARY FIRST â•â•â•â•â•â•"),await async function(){console.log("[AMA] boundary layer disabled - using province/counties instead"),window.boundary=null}(0,{keepOld:!1}),console.log("[AMA] Boundary created successfully"),console.log("[AMA] Before enforceDefaultVisibility - Layers on map:",{wind:E.hasLayer(n.G.wind),solar:E.hasLayer(n.G.solar),dams:E.hasLayer(n.G.dams),counties:E.hasLayer(n.G.counties),province:E.hasLayer(n.G.province)}),m(E),setTimeout(()=>m(E),0),console.log("[AMA] After enforceDefaultVisibility - Layers on map:",{wind:E.hasLayer(n.G.wind),solar:E.hasLayer(n.G.solar),dams:E.hasLayer(n.G.dams),counties:E.hasLayer(n.G.counties),province:E.hasLayer(n.G.province)}),console.log("[AMA] â•â•â•â•â•â• FORCING ALL LAYERS TO MAP â•â•â•â•â•â•"),["province","counties","wind","solar","dams"].forEach(e=>{const o=n.G[e];if(!o)return void console.error(`[AMA] Group ${e} does not exist!`);const t=o.getLayers(),a=t.length,i=E.hasLayer(o);let r="no bounds";try{const e=t[0];if(e&&"function"==typeof e.getBounds){const n=e.getBounds();n&&n._southWest&&n._northEast&&(r=`${n._southWest.lat.toFixed(2)},${n._southWest.lng.toFixed(2)} â†’ ${n._northEast.lat.toFixed(2)},${n._northEast.lng.toFixed(2)}`)}}catch(e){r="error: "+e.message}console.log(`[AMA] ${e}:`,{layerCount:a,isOnMap:i,bounds:r,action:i?"already on map":"adding to map..."}),!i&&a>0&&(o.addTo(E),console.log(`[AMA] âœ… ${e} forcefully added to map!`),setTimeout(()=>{E.hasLayer(o)?console.log(`[AMA] âœ“ ${e} confirmed on map`):console.error(`[AMA] âœ— ${e} FAILED to add to map!`)},100))}),console.log("[AMA] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),window.AMA&&n.initPanelDirectWire&&n.initPanelDirectWire(),console.log("[AMA] â•â•â•â•â•â• FITTING BOUNDS â•â•â•â•â•â•");const C=[];if(["province","counties"].forEach(e=>{const o=n.G[e];if(o&&o.getLayers().length>0)try{const n=o.getLayers()[0];if(n&&"function"==typeof n.getBounds){const o=n.getBounds();o&&o.isValid&&o.isValid()&&(C.push(o),console.log(`[AMA] ${e} bounds:`,{sw:`${o._southWest.lat.toFixed(2)},${o._southWest.lng.toFixed(2)}`,ne:`${o._northEast.lat.toFixed(2)},${o._northEast.lng.toFixed(2)}`}))}}catch(n){console.error(`[AMA] Error getting bounds for ${e}:`,n)}}),C.length>0){let e=C[0];for(let n=1;n<C.length;n++)e.extend(C[n]);console.log("[AMA] Fitting map to combined bounds..."),E.fitBounds(e,{padding:[50,50]}),console.log("[AMA] âœ… Map fitted to bounds!")}else console.error("[AMA] âŒ No valid bounds found! Using default center."),E.setView([36.3,59.6],7);if(console.log("[AMA] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),E.on("layeradd overlayadd overlayremove",()=>{undefined}),window.__AMA_COUNTS={counties:(d?.features||[]).length,province:(A?.features||[]).length,wind:(u?.features||[]).length,solar:(w?.features||[]).length,dams:(_?.features||[]).length},window.__dumpAmaState=function(){const e={manifestUrl:r,baseData:s?.baseData||null,paths:window.__AMA_BASE_PATHS,counts:window.__AMA_COUNTS};return window.AMA_DEBUG&&console.log("[AMA] dump",e),e},await b(l),window.__AMA_BOOTSTRAPPED=!0,window.__AMA_BOOTING=!1,window.AMA_DEBUG){const e=performance.now?performance.now():Date.now();console.log("[AMA] bootstrap done in",Math.round(e-t),"ms")}}();
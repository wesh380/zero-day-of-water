<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ماشین‌حساب فوتوکشت — wesh360</title>
  <!-- React 18 UMD + ReactDOM  -->
  <script charset="utf-8" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script charset="utf-8" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel Ã˜Â¨Ã˜Â±Ã˜Â§Ã›Å’ Ã˜Â§Ã˜Â¬Ã˜Â±Ã˜Â§Ã›Å’ JSX Ã˜Â¯Ã˜Â± Ã™â€¦Ã˜Â±Ã™Ë†Ã˜Â±ÃšÂ¯Ã˜Â± (Ã™ÂÃ™â€šÃ˜Â· Ã˜Â¬Ã™â€¡Ã˜Âª Ã˜Â§Ã˜Â³Ã˜ÂªÃ™â€šÃ˜Â±Ã˜Â§Ã˜Â± Ã˜Â³Ã˜Â±Ã›Å’Ã˜Â¹Ã˜â€º Ã˜Â¨Ã˜Â±Ã˜Â§Ã›Å’ Ã™â€ Ã˜Â³Ã˜Â®Ã™â€¡ Ã™â€ Ã™â€¡Ã˜Â§Ã›Å’Ã›Å’ Ã˜Â¨Ã™â€¡Ã˜ÂªÃ˜Â± Ã˜Â§Ã˜Â³Ã˜Âª Ã˜Â¨Ã›Å’Ã™â€žÃ˜Â¯ ÃšÂ©Ã™â€ Ã›Å’Ã˜Â¯) -->
  <script charset="utf-8" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="stylesheet" href="../../assets/tailwind.css">
  <link rel="stylesheet" href="/assets/unified-badge.css">
  <link rel="stylesheet" href="/assets/global-footer.css">
  <link rel="stylesheet" href="../../assets/site-overrides.css">
  <link rel="stylesheet" href="../../assets/inline-migration.css">
</head>
<body>
  <div id="root"></div>
  <button id="btn-api-selftest" class="agv-selftest-trigger">API Self Test</button>

  <script charset="utf-8" type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // Ã™â€ Ã˜Â³Ã˜Â®Ã™â€¡ Ã™â€¦Ã˜Â®Ã˜ÂµÃ™Ë†Ã˜Âµ Ã˜Â§Ã˜Â³Ã˜ÂªÃ˜Â§Ã™â€  Ã˜Â®Ã˜Â±Ã˜Â§Ã˜Â³Ã˜Â§Ã™â€  Ã˜Â±Ã˜Â¶Ã™Ë†Ã›Å’ (Ã˜Â³Ã˜Â§Ã˜Â¯Ã™â€¡ Ã˜Â¨Ã˜Â±Ã˜Â§Ã›Å’ ÃšÂ©Ã˜Â´Ã˜Â§Ã™Ë†Ã˜Â±Ã˜Â²Ã˜Â§Ã™â€ )
    // Ã™â€ ÃšÂ©Ã˜ÂªÃ™â€¡: Ã˜Â§Ã˜Â¹Ã˜Â¯Ã˜Â§Ã˜Â¯ Ã™Â¾Ã›Å’Ã˜Â´Ã¢â‚¬Å’Ã™ÂÃ˜Â±Ã˜Â¶ Ã˜ÂªÃ™â€šÃ˜Â±Ã›Å’Ã˜Â¨Ã›Å’ Ã™â€¡Ã˜Â³Ã˜ÂªÃ™â€ Ã˜Â¯. Ã™â€žÃ˜Â·Ã™ÂÃ˜Â§Ã™â€¹ Ã˜Â¨Ã˜Â§ Ã˜Â´Ã˜Â±Ã˜Â§Ã›Å’Ã˜Â· Ã™Ë†Ã˜Â§Ã™â€šÃ˜Â¹Ã›Å’ Ã˜Â²Ã™â€¦Ã›Å’Ã™â€  Ã˜Â®Ã™Ë†Ã˜Â¯Ã˜ÂªÃ˜Â§Ã™â€  Ã˜ÂªÃ™â€ Ã˜Â¸Ã›Å’Ã™â€¦ ÃšÂ©Ã™â€ Ã›Å’Ã˜Â¯.

    // Ã˜Â§Ã˜Â¬Ã˜Â²Ã˜Â§Ã›Å’ ÃšÂ©Ã™â€¦ÃšÂ©Ã›Å’ Ã˜Â³Ã˜Â§Ã˜Â¯Ã™â€¡
    const Section = ({ title, children }) => (
      <section className="bg-neutral-950/60 border border-neutral-800 rounded-2xl p-4 md:p-6 shadow-xl">
        <h2 className="text-emerald-400 text-base md:text-lg font-bold mb-3">{title}</h2>
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">{children}</div>
      </section>
    );

    const NumberInput = ({ label, value, onChange, step = 1 }) => (
      <label className="flex flex-col gap-1 text-sm">
        <span className="text-gray-200">{label}</span>
        <input dir="ltr" type="number" step={step} value={value}
          onChange={(e)=>onChange(Number(e.target.value))}
          className="w-full rounded-xl bg-neutral-900 border border-neutral-700 px-3 py-2 text-right text-gray-100 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
      </label>
    );

    const Select = ({ label, value, onChange, options }) => (
      <label className="flex flex-col gap-1 text-sm">
        <span className="text-gray-200">{label}</span>
        <select value={value} onChange={(e)=>onChange(e.target.value)}
          className="w-full rounded-xl bg-neutral-900 border border-neutral-700 px-3 py-2 text-right text-gray-100">
          {options.map(o=> <option key={o.value} value={o.value}>{o.label}</option>)}
        </select>
      </label>
    );

    const KPI = ({ title, value, sub }) => (
      <div className="rounded-2xl bg-neutral-950/60 border border-neutral-800 p-4 shadow-xl">
        <div className="text-gray-300 text-sm">{title}</div>
        <div className="text-xl md:text-2xl font-extrabold mt-1 text-emerald-400">{value}</div>
        {sub && <div className="text-xs text-gray-400 mt-1">{sub}</div>}
      </div>
    );

      const KV = ({ k, v }) => (
        <div className="rounded-xl bg-neutral-900/50 border border-neutral-800 p-3">
          <div className="text-gray-400 text-xs">{k}</div>
          <div className="text-sm md:text-base font-semibold text-gray-100 mt-0.5">{v}</div>
        </div>
      );

      async function saveScenario(state) {
        const { apiFetch } = await import('/assets/js/api.js');
        const res = await apiFetch("/api/save-scenario", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ state })
        });
        const { id } = await res.json();
        const share = `${location.origin}${location.pathname}?id=${encodeURIComponent(id)}`;
        alert("Ã˜Â°Ã˜Â®Ã›Å’Ã˜Â±Ã™â€¡ Ã˜Â´Ã˜Â¯! Ã˜Â§Ã›Å’Ã™â€  Ã™â€žÃ›Å’Ã™â€ ÃšÂ© Ã˜Â±Ã˜Â§ Ã™â€ ÃšÂ¯Ã™â€¡ Ã˜Â¯Ã˜Â§Ã˜Â±Ã›Å’Ã˜Â¯:
" + share);
      }

      async function loadScenarioIfAny(setState) {
        const id = new URLSearchParams(location.search).get("id");
        if (!id) return;
        const { apiFetch } = await import('/assets/js/api.js');
        const res = await apiFetch(`/api/get-scenario?id=${encodeURIComponent(id)}`);
        const saved = await res.json();
        if (saved) setState(saved);
      }

      function AgrivoltaicsKhorasan(){
        const [simple, setSimple] = useState(true);

      // Ã™â€¦Ã™â€ Ã˜Â·Ã™â€šÃ™â€¡Ã¢â‚¬Å’Ã™â€¡Ã˜Â§Ã›Å’ Ã™Â¾Ã˜Â±Ã˜ÂªÃšÂ©Ã˜Â±Ã˜Â§Ã˜Â± Ã˜Â§Ã˜Â³Ã˜ÂªÃ˜Â§Ã™â€  (Ã˜ÂªÃ™â€šÃ˜Â±Ã›Å’Ã˜Â¨Ã›Å’)
      const regions = {
        mashhad: { title: "Ã˜Â¯Ã˜Â´Ã˜Âª Ã™â€¦Ã˜Â´Ã™â€¡Ã˜Â¯ / Ãšâ€ Ã™â€ Ã˜Â§Ã˜Â±Ã˜Â§Ã™â€ ", sun: 1675, heat: "med" },
        neyshabur: { title: "Ã™â€ Ã›Å’Ã˜Â´Ã˜Â§Ã˜Â¨Ã™Ë†Ã˜Â± / Ã™ÂÃ›Å’Ã˜Â±Ã™Ë†Ã˜Â²Ã™â€¡", sun: 1680, heat: "med" },
        torbat: { title: "Ã˜ÂªÃ˜Â±Ã˜Â¨Ã˜ÂªÃ¢â‚¬Å’Ã˜Â­Ã›Å’Ã˜Â¯Ã˜Â±Ã›Å’Ã™â€¡ / Ã˜Â²Ã˜Â§Ã™Ë†Ã™â€¡ / Ã™â€¦Ã™â€¡Ã¢â‚¬Å’Ã™Ë†Ã™â€žÃ˜Â§Ã˜Âª / ÃšÂ¯Ã™â€ Ã˜Â§Ã˜Â¨Ã˜Â§Ã˜Â¯", sun: 1800, heat: "high" },
        sabzevar: { title: "Ã˜Â³Ã˜Â¨Ã˜Â²Ã™Ë†Ã˜Â§Ã˜Â± / Ã˜Â¨Ã˜Â±Ã˜Â¯Ã˜Â³ÃšÂ©Ã™â€  / ÃšÂ©Ã˜Â§Ã˜Â´Ã™â€¦Ã˜Â±", sun: 1750, heat: "high" },
        quchan: { title: "Ã™â€šÃ™Ë†Ãšâ€ Ã˜Â§Ã™â€  / Ã˜Â¯Ã˜Â±ÃšÂ¯Ã˜Â² / ÃšÂ©Ã™â€žÃ˜Â§Ã˜Âª", sun: 1625, heat: "low" },
        torbat_jam: { title: "Ã˜ÂªÃ˜Â±Ã˜Â¨Ã˜ÂªÃ¢â‚¬Å’Ã˜Â¬Ã™â€¦ / Ã˜ÂªÃ˜Â§Ã›Å’Ã˜Â¨Ã˜Â§Ã˜Â¯ / Ã™ÂÃ˜Â±Ã›Å’Ã™â€¦Ã˜Â§Ã™â€  / Ã˜Â®Ã™Ë†Ã˜Â§Ã™Â", sun: 1780, heat: "high" },
      };

      // Ã™â€¦Ã˜Â­Ã˜ÂµÃ™Ë†Ã™â€žÃ˜Â§Ã˜Âª Ã˜Â±Ã˜Â§Ã›Å’Ã˜Â¬
      const cropProfiles = {
        "Ã˜Â²Ã˜Â¹Ã™ÂÃ˜Â±Ã˜Â§Ã™â€ ": { baseYieldChange: 6, waterSaving: -28, price_per_t: 2000000000, yield_t_ha: 4 },
        "ÃšÂ¯Ã™â€ Ã˜Â¯Ã™â€¦": { baseYieldChange: -2, waterSaving: -10, price_per_t: 500000000, yield_t_ha: 5.5 },
        "Ã˜Â¬Ã™Ë†": { baseYieldChange: -3, waterSaving: -10, price_per_t: 420000000, yield_t_ha: 4.5 },
        "Ã™Â¾Ã˜Â³Ã˜ÂªÃ™â€¡": { baseYieldChange: -3, waterSaving: -20, price_per_t: 1800000000, yield_t_ha: 1.0 },
        "Ã˜Â§Ã™â€ ÃšÂ¯Ã™Ë†Ã˜Â±": { baseYieldChange: 1, waterSaving: -15, price_per_t: 250000000, yield_t_ha: 20 },
        "Ã˜Â³Ã˜Â¨Ã˜Â²Ã›Å’Ã˜Â¬Ã˜Â§Ã˜Âª Ã˜Â¨Ã˜Â±ÃšÂ¯Ã›Å’": { baseYieldChange: 8, waterSaving: -30, price_per_t: 250000000, yield_t_ha: 20 },
        "Ã˜Â·Ã˜Â§Ã™â€žÃ˜Â¨Ã›Å’/Ã˜Â®Ã˜Â±Ã˜Â¨Ã˜Â²Ã™â€¡": { baseYieldChange: 2, waterSaving: -20, price_per_t: 180000000, yield_t_ha: 15 },
      };

      // Ã˜Â¢Ã˜Â¨ Ã™Ë† Ã˜Â®Ã˜Â§ÃšÂ©
      const waterSources = {
        well_electric_subsidized: { title: "Ãšâ€ Ã˜Â§Ã™â€¡ Ã¢â‚¬â€œ Ã˜Â¨Ã˜Â±Ã™â€š Ã›Å’Ã˜Â§Ã˜Â±Ã˜Â§Ã™â€ Ã™â€¡Ã¢â‚¬Å’Ã˜Â§Ã›Å’", elec_tariff: 1000, water_cost: 0 },
        well_electric_normal: { title: "Ãšâ€ Ã˜Â§Ã™â€¡ Ã¢â‚¬â€œ Ã˜Â¨Ã˜Â±Ã™â€š Ã™â€¦Ã˜Â¹Ã™â€¦Ã™Ë†Ã™â€žÃ›Å’", elec_tariff: 3000, water_cost: 0 },
        well_diesel: { title: "Ãšâ€ Ã˜Â§Ã™â€¡ Ã¢â‚¬â€œ Ã˜Â¯Ã›Å’Ã˜Â²Ã™â€žÃ›Å’", elec_tariff: 6000, water_cost: 0 },
        qanat: { title: "Ã™â€šÃ™â€ Ã˜Â§Ã˜Âª / Ã˜Â¢Ã˜Â¨ Ã˜Â«Ã™â€šÃ™â€žÃ›Å’", elec_tariff: 0, water_cost: 5000 },
        canal: { title: "ÃšÂ©Ã˜Â§Ã™â€ Ã˜Â§Ã™â€ž/Ã˜Â´Ã˜Â¨ÃšÂ©Ã™â€¡ Ã˜Â¢Ã˜Â¨Ã›Å’Ã˜Â§Ã˜Â±Ã›Å’", elec_tariff: 0, water_cost: 20000 },
      };
      const dustLevels = { low: { title: "ÃšÂ¯Ã˜Â±Ã˜Â¯ Ã™Ë† Ã˜ÂºÃ˜Â¨Ã˜Â§Ã˜Â± ÃšÂ©Ã™â€¦", soiling: 3 }, med: { title: "ÃšÂ¯Ã˜Â±Ã˜Â¯ Ã™Ë† Ã˜ÂºÃ˜Â¨Ã˜Â§Ã˜Â± Ã™â€¦Ã˜ÂªÃ™Ë†Ã˜Â³Ã˜Â·", soiling: 5 }, high: { title: "ÃšÂ¯Ã˜Â±Ã˜Â¯ Ã™Ë† Ã˜ÂºÃ˜Â¨Ã˜Â§Ã˜Â± Ã˜Â²Ã›Å’Ã˜Â§Ã˜Â¯", soiling: 8 } };
      const soils = { sandy: { title: "Ã˜Â´Ã™â€ Ã›Å’", pump_kWh_m3: 0.45 }, loam: { title: "Ã™â€žÃ™Ë†Ã™â€¦ (Ã™â€¦Ã›Å’Ã˜Â§Ã™â€ Ã¢â‚¬Å’Ã˜Â¯Ã˜Â§Ã™â€ Ã™â€¡)", pump_kWh_m3: 0.5 }, clay: { title: "Ã˜Â±Ã˜Â³Ã›Å’", pump_kWh_m3: 0.55 } };

      // Ã™Ë†Ã˜Â¶Ã˜Â¹Ã›Å’Ã˜Âª Ã™Ë†Ã˜Â±Ã™Ë†Ã˜Â¯Ã›Å’Ã¢â‚¬Å’Ã™â€¡Ã˜Â§
        const [s, setS] = useState({
        region: "torbat",
        crop_type: "Ã˜Â²Ã˜Â¹Ã™ÂÃ˜Â±Ã˜Â§Ã™â€ ",
        water_source: "well_electric_subsidized",
        dust_level: "med",
        soil_type: "loam",
        salinity_EC: 3,
        project_area_ha: 1,
        time_horizon_years: 25,
        discount_rate_pct: 12,
        currency: "Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž",
        baseline_yield_t_per_ha: cropProfiles["Ã˜Â²Ã˜Â¹Ã™ÂÃ˜Â±Ã˜Â§Ã™â€ "].yield_t_ha,
        expected_yield_change_pct_under_AGV: cropProfiles["Ã˜Â²Ã˜Â¹Ã™ÂÃ˜Â±Ã˜Â§Ã™â€ "].baseYieldChange,
        crop_price_per_t: cropProfiles["Ã˜Â²Ã˜Â¹Ã™ÂÃ˜Â±Ã˜Â§Ã™â€ "].price_per_t,
        crop_quality_premium_or_discount_pct: 0,
        ag_opex_baseline_per_ha: 600000000,
        ag_opex_change_under_AGV_pct: -5,
        water_use_baseline_m3_per_ha: 6000,
        water_use_change_under_AGV_pct: cropProfiles["Ã˜Â²Ã˜Â¹Ã™ÂÃ˜Â±Ã˜Â§Ã™â€ "].waterSaving,
        pv_capacity_kWp_total: 150,
        module_price_per_kWp: 220000000,
        mounting_structure_cost_per_kWp: 70000000,
        inverter_BOS_cost_per_kWp: 60000000,
        grid_interconnection_lump_sum: 5000000000,
        EPC_soft_cost_pct_of_capex: 8,
        annual_pv_degradation_pct: 0.6,
        specific_yield_kWh_per_kWp_year: regions["torbat"].sun,
        soiling_loss_pct: dustLevels["med"].soiling,
        availability_pct: 98,
        pv_om_cost_per_kWp_year: 2500000,
        grid_scheme: "PPA/FIT",
        ppa_or_fit_tariff: 2500,
        net_metering_buy_price: 3000,
        net_metering_sell_price: 2200,
        self_consumption_share_pct: 40,
        curtailment_pct: 0,
        tariff_escalation_pct_per_year: 5,
        subsidy_capex_pct: 0,
        carbon_credit_price_per_tCO2: 0,
        avoided_co2_t_per_MWh: 0.55,
        insurance_cost_pct_of_asset_value_per_year: 1.2,
        land_lease_cost_per_ha_year: 0,
          tax_rate_pct: 0,
        });

        useEffect(() => {
          loadScenarioIfAny(setS);
        }, []);

        const set = (k, v) => setS(prev => ({ ...prev, [k]: v }));
      const pct = (x) => (Number(x) || 0) / 100;
      const nz = (x) => Number(x) || 0;
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      const fmt = (n) => new Intl.NumberFormat("fa-IR").format(Math.round(n || 0));
      const fmtMoney = (n) => `${fmt(n)} ${s.currency}`;

      useEffect(() => {
        const reg = regions[s.region];
        const crop = cropProfiles[s.crop_type] || cropProfiles["Ã˜Â²Ã˜Â¹Ã™ÂÃ˜Â±Ã˜Â§Ã™â€ "];
        const dust = dustLevels[s.dust_level];
        const src = waterSources[s.water_source];
        const soil = soils[s.soil_type];

        const newSpecificYield = reg.sun;
        const newSoiling = dust.soiling;
        const newIrrTariff = src.elec_tariff;
        const newWaterCost = src.water_cost;
        const newPumpKWhm3 = soil.pump_kWh_m3;

        const heat = reg.heat; // low/med/high
        let yieldChange = crop.baseYieldChange;
        let waterSaving = crop.waterSaving;
        if (heat === "high") { yieldChange += 1; waterSaving -= 3; }
        if (heat === "low")  { yieldChange -= 1; waterSaving += 2; }
        if (s.salinity_EC >= 4 && s.salinity_EC < 8) { yieldChange += 1; waterSaving -= 2; }
        if (s.salinity_EC >= 8) { yieldChange += 2; waterSaving -= 3; }

        setS(prev => ({
          ...prev,
          specific_yield_kWh_per_kWp_year: newSpecificYield,
          soiling_loss_pct: newSoiling,
          irrigation_energy_tariff: newIrrTariff ?? prev.irrigation_energy_tariff,
          water_unit_cost: newWaterCost ?? prev.water_unit_cost,
          energy_for_irrigation_kWh_per_m3: newPumpKWhm3 ?? prev.energy_for_irrigation_kWh_per_m3,
          expected_yield_change_pct_under_AGV: yieldChange,
          water_use_change_under_AGV_pct: waterSaving,
          baseline_yield_t_per_ha: crop.yield_t_ha,
          crop_price_per_t: crop.price_per_t,
        }));
      }, [s.region, s.crop_type, s.dust_level, s.water_source, s.soil_type, s.salinity_EC]);

      const area = nz(s.project_area_ha);
      const years = Math.max(1, Math.floor(nz(s.time_horizon_years)));

      const capex_per_kWp_sub = nz(s.module_price_per_kWp) + nz(s.mounting_structure_cost_per_kWp) + nz(s.inverter_BOS_cost_per_kWp);
      const capex_kWp_with_soft = capex_per_kWp_sub * (1 + pct(s.EPC_soft_cost_pct_of_capex));
      const subsidy = capex_kWp_with_soft * pct(s.subsidy_capex_pct);
      const capex_total = Math.max(0, nz(s.pv_capacity_kWp_total) * (capex_kWp_with_soft - subsidy) + nz(s.grid_interconnection_lump_sum));

      const pv_om_annual = nz(s.pv_capacity_kWp_total) * nz(s.pv_om_cost_per_kWp_year);
      const insurance_annual = capex_total * pct(s.insurance_cost_pct_of_asset_value_per_year);
      const land_lease_annual = area * nz(s.land_lease_cost_per_ha_year);

      const ag_yield_baseline = nz(s.baseline_yield_t_per_ha) * area;
      const ag_rev_baseline = ag_yield_baseline * nz(s.crop_price_per_t);
      const ag_opex_baseline_total = area * nz(s.ag_opex_baseline_per_ha);
      const water_m3_base = area * nz(s.water_use_baseline_m3_per_ha);
      const water_cost_base = water_m3_base * nz(s.water_unit_cost);
      const irrigation_energy_base_kWh = water_m3_base * nz(s.energy_for_irrigation_kWh_per_m3);
      const irrigation_energy_cost_base = irrigation_energy_base_kWh * nz(s.irrigation_energy_tariff || 0);

      const yield_change = 1 + pct(s.expected_yield_change_pct_under_AGV) + pct(s.crop_quality_premium_or_discount_pct);
      const ag_yield_agv = nz(s.baseline_yield_t_per_ha) * area * yield_change;
      const ag_rev_agv = ag_yield_agv * nz(s.crop_price_per_t);
      const ag_opex_agv_total = area * nz(s.ag_opex_baseline_per_ha) * (1 + pct(s.ag_opex_change_under_AGV_pct));
      const water_m3_agv = water_m3_base * (1 + pct(s.water_use_change_under_AGV_pct));
      const water_cost_agv = water_m3_agv * nz(s.water_unit_cost);
      const irrigation_energy_agv_kWh = water_m3_agv * nz(s.energy_for_irrigation_kWh_per_m3);
      const irrigation_energy_cost_agv = irrigation_energy_agv_kWh * nz(s.irrigation_energy_tariff || 0);

      const net_yield_factor = (1 - pct(s.soiling_loss_pct)) * (pct(s.availability_pct));
      const curtail = (1 - pct(s.curtailment_pct));
      const kWp = nz(s.pv_capacity_kWp_total);
      const annualPV = (y) => kWp * nz(s.specific_yield_kWh_per_kWp_year) * net_yield_factor * curtail * Math.pow(1 - pct(s.annual_pv_degradation_pct), y);
      const tariffEscal = (y) => Math.pow(1 + pct(s.tariff_escalation_pct_per_year), y);

      const elecRevenueYear = (y) => {
        const kWh = annualPV(y);
        const scheme = s.grid_scheme;
        if (scheme === "PPA/FIT") return kWh * nz(s.ppa_or_fit_tariff) * tariffEscal(y);
        if (scheme === "SelfConsumption") {
          const selfShare = Math.max(0, Math.min(1, pct(s.self_consumption_share_pct)));
          const self_kWh = kWh * selfShare;
          return self_kWh * nz(s.net_metering_buy_price) * tariffEscal(y);
        }
        const selfShare = Math.max(0, Math.min(1, pct(s.self_consumption_share_pct)));
        const self_kWh = kWh * selfShare;
        const export_kWh = kWh * (1 - selfShare);
        const avoided = self_kWh * nz(s.net_metering_buy_price) * tariffEscal(y);
        const sold = export_kWh * nz(s.net_metering_sell_price) * tariffEscal(y);
        return avoided + sold;
      };

      const carbonRevenueYear = (y) => (annualPV(y) / 1000) * nz(s.avoided_co2_t_per_MWh) * nz(s.carbon_credit_price_per_tCO2);

      const baselineAnnualNet = () => (
        ag_rev_baseline - ag_opex_baseline_total - water_cost_base - irrigation_energy_cost_base - land_lease_annual
      );
      const agvAnnualNetBeforePV = () => (
        ag_rev_agv - ag_opex_agv_total - water_cost_agv - irrigation_energy_cost_agv - land_lease_annual
      );
      const agvAnnualNet = (y) => (
        agvAnnualNetBeforePV() + elecRevenueYear(y) + carbonRevenueYear(y) - pv_om_annual - insurance_annual
      );

      const cashflowsBaseline = Array.from({ length: years }, () => baselineAnnualNet());
      const cashflowsAGV = Array.from({ length: years }, (_, y) => agvAnnualNet(y));
      const cashflowsAGV_WithCapex = [ -capex_total, ...cashflowsAGV ];
      const cashflowsBaseline_ZeroCapex = [ 0, ...cashflowsBaseline ];
      const cashflowsIncremental = cashflowsAGV_WithCapex.map((v, i) => v - (cashflowsBaseline_ZeroCapex[i] ?? 0));

      const npv = (ratePct, arr) => arr.reduce((acc, cf, i) => acc + cf / Math.pow(1 + (ratePct/100), i), 0);
      const irr = (arr) => { let lo=-0.9, hi=1.0; const f=r=>arr.reduce((a,c,i)=>a+c/Math.pow(1+r,i),0); let flo=f(lo), fhi=f(hi); if(isNaN(flo)||isNaN(fhi)||flo*fhi>0) return null; for(let k=0;k<80;k++){ const mid=(lo+hi)/2, fm=f(mid); if(Math.abs(fm)<1e-3) return mid; if(flo*fm<0){hi=mid; fhi=fm;} else {lo=mid; flo=fm;} } return (lo+hi)/2; };

      const NPV_incremental = npv(s.discount_rate_pct, cashflowsIncremental);
      const IRR_incremental = irr(cashflowsIncremental);

      const decisionText = () => {
        if (NPV_incremental > 0 && (IRR_incremental ?? 0) > (s.discount_rate_pct/100)) return "Ã˜Â¨Ã™â€¡Ã¢â‚¬Å’Ã˜ÂµÃ˜Â±Ã™ÂÃ™â€¡";
        if (Math.abs(NPV_incremental) < 0.05 * capex_total) return "Ã˜ÂªÃ™â€šÃ˜Â±Ã›Å’Ã˜Â¨Ã˜Â§Ã™â€¹ Ã˜Â³Ã˜Â± Ã˜Â¨Ã™â€¡ Ã˜Â³Ã˜Â±";
        return "Ã˜Â¨Ã™â€¡Ã¢â‚¬Å’Ã˜ÂµÃ˜Â±Ã™ÂÃ™â€¡ Ã™â€ Ã›Å’Ã˜Â³Ã˜Âª";
      };

      const totalPVkWhYear1 = annualPV(0);

      const Chart = ({ data, title, height=160 }) => {
        const w = 720, h = height, pad = 24;
        const n = data.length;
        const min = Math.min(...data, 0), max = Math.max(...data, 0);
        const scaleX = (i) => pad + (i * (w - 2*pad)) / Math.max(1, n - 1);
        const scaleY = (v) => { if (max === min) return h/2; return h - pad - ((v - min) * (h - 2*pad)) / (max - min); };
        const path = data.map((v,i)=> `${i===0?'M':'L'}${scaleX(i)},${scaleY(v)}`).join(' ');
        const zeroY = scaleY(0);
        return (
          <div className="rounded-2xl bg-neutral-950/60 border border-neutral-800 p-4">
            <div className="text-gray-300 text-sm mb-2">{title}</div>
            <svg width={w} height={h} className="max-w-full">
              <line x1={pad} y1={zeroY} x2={w-pad} y2={zeroY} stroke="#444" strokeDasharray="4 4" />
              <path d={path} fill="none" stroke="#10b981" strokeWidth="2" />
            </svg>
          </div>
        );
      };

      const downloadCSV = () => {
        const rows = [["Ã˜Â³Ã˜Â§Ã™â€ž","Ã˜Â¨Ã˜Â±Ã™â€š (kWh)","Ã˜Â¯Ã˜Â±Ã˜Â¢Ã™â€¦Ã˜Â¯/Ã˜ÂµÃ˜Â±Ã™ÂÃ™â€¡Ã¢â‚¬Å’Ã˜Â¬Ã™Ë†Ã›Å’Ã›Å’ Ã˜Â¨Ã˜Â±Ã™â€š","Ã˜Â®Ã˜Â§Ã™â€žÃ˜Âµ ÃšÂ©Ã˜Â´Ã˜Â§Ã™Ë†Ã˜Â±Ã˜Â²Ã›Å’ (Ã™â€šÃ˜Â¨Ã™â€ž)","Ã˜Â®Ã˜Â§Ã™â€žÃ˜Âµ ÃšÂ©Ã˜Â´Ã˜Â§Ã™Ë†Ã˜Â±Ã˜Â²Ã›Å’ (Ã˜Â¨Ã˜Â§)","Ã˜Â§Ã™ÂÃ˜Â²Ã˜Â§Ã›Å’Ã˜Â´Ã›Å’"]];
        for (let i=0;i<years;i++) rows.push([ i+1, Math.round(annualPV(i)), Math.round(elecRevenueYear(i)), Math.round(cashflowsBaseline[i]), Math.round(cashflowsAGV[i]), Math.round(cashflowsIncremental[i+1] ?? 0) ]);
        const csv = rows.map(r=>r.join(",")).join("
");
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'agrivoltaics_khorasan.csv'; a.click(); URL.revokeObjectURL(url);
      };

      return (
        <div dir="rtl" className="min-h-screen w-full bg-gradient-to-b from-neutral-950 to-neutral-900 text-gray-100 px-4 py-6 md:py-10 md:px-8">
          <header className="max-w-7xl mx-auto mb-6 md:mb-8 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div>
              <h1 className="text-2xl md:text-3xl font-extrabold tracking-tight">Ã™â€¦Ã˜Â§Ã˜Â´Ã›Å’Ã™â€ Ã¢â‚¬Å’Ã˜Â­Ã˜Â³Ã˜Â§Ã˜Â¨ Ã™ÂÃ™Ë†Ã˜ÂªÃ™Ë†ÃšÂ©Ã™ÂÃ˜Â´Ã˜Âª Ã¢â‚¬â€œ Ã™Ë†Ã›Å’ÃšËœÃ™â€¡ Ã˜Â®Ã˜Â±Ã˜Â§Ã˜Â³Ã˜Â§Ã™â€  Ã˜Â±Ã˜Â¶Ã™Ë†Ã›Å’</h1>
              <p className="text-sm md:text-base text-gray-300 mt-2">Ã˜Â¨Ã˜Â§ Ãšâ€ Ã™â€ Ã˜Â¯ Ã™Ë†Ã˜Â±Ã™Ë†Ã˜Â¯Ã›Å’ Ã˜Â³Ã˜Â§Ã˜Â¯Ã™â€¡ Ã˜Â¨Ã˜Â¨Ã›Å’Ã™â€ Ã›Å’Ã˜Â¯ ÃšÂ©Ã™ÂÃ˜Â´Ã˜Âª Ã˜Â²Ã›Å’Ã˜Â± Ã™Â¾Ã™â€ Ã™â€ž Ã˜Â®Ã™Ë†Ã˜Â±Ã˜Â´Ã›Å’Ã˜Â¯Ã›Å’ Ã˜Â¯Ã˜Â± Ã™â€¦Ã™â€ Ã˜Â·Ã™â€šÃ™â€¡ Ã˜Â´Ã™â€¦Ã˜Â§ Ã™â€¦Ã›Å’Ã¢â‚¬Å’Ã˜ÂµÃ˜Â±Ã™ÂÃ˜Â¯ Ã›Å’Ã˜Â§ Ã™â€ Ã™â€¡.</p>
              <div className="mt-2 text-xs text-gray-400 space-y-1">
                <div>Ã›Â±) Ã™â€¦Ã™â€ Ã˜Â·Ã™â€šÃ™â€¡Ã˜Å’ Ã™â€¦Ã˜Â­Ã˜ÂµÃ™Ë†Ã™â€žÃ˜Å’ Ã˜Â¢Ã˜Â¨ Ã™Ë† Ã˜Â®Ã˜Â§ÃšÂ© Ã˜Â±Ã˜Â§ Ã˜Â§Ã™â€ Ã˜ÂªÃ˜Â®Ã˜Â§Ã˜Â¨ ÃšÂ©Ã™â€ Ã›Å’Ã˜Â¯. Ã˜Â§Ã˜Â¹Ã˜Â¯Ã˜Â§Ã˜Â¯ Ã™Â¾Ã›Å’Ã˜Â´Ã¢â‚¬Å’Ã™ÂÃ˜Â±Ã˜Â¶ Ã˜Â¨Ã˜Â± Ã˜Â§Ã˜Â³Ã˜Â§Ã˜Â³ Ã˜Â´Ã˜Â±Ã˜Â§Ã›Å’Ã˜Â· Ã˜Â±Ã˜Â§Ã›Å’Ã˜Â¬ Ã˜Â§Ã˜Â³Ã˜ÂªÃ˜Â§Ã™â€  Ã™Â¾Ã˜Â± Ã™â€¦Ã›Å’Ã¢â‚¬Å’Ã˜Â´Ã™Ë†Ã™â€ Ã˜Â¯.</div>
                <div>Ã›Â²) Ã˜Â§ÃšÂ¯Ã˜Â± Ã™â€žÃ˜Â§Ã˜Â²Ã™â€¦ Ã˜Â¨Ã™Ë†Ã˜Â¯Ã˜Å’ Ã™â€šÃ›Å’Ã™â€¦Ã˜ÂªÃ¢â‚¬Å’Ã™â€¡Ã˜Â§ Ã™Ë† Ã™â€¦Ã™â€šÃ˜Â§Ã˜Â¯Ã›Å’Ã˜Â± Ã˜Â±Ã˜Â§ Ã˜Â¨Ã˜Â§ Ã™Ë†Ã˜Â¶Ã˜Â¹Ã›Å’Ã˜Âª Ã˜Â®Ã™Ë†Ã˜Â¯Ã˜ÂªÃ˜Â§Ã™â€  Ã˜Â¹Ã™Ë†Ã˜Â¶ ÃšÂ©Ã™â€ Ã›Å’Ã˜Â¯.</div>
                <div>Ã›Â³) Ã™â€ Ã˜ÂªÃ›Å’Ã˜Â¬Ã™â€¡ Ã˜Â±Ã˜Â§ Ã˜Â¯Ã˜Â± ÃšÂ©Ã˜Â§Ã˜Â±Ã˜ÂªÃ¢â‚¬Å’Ã™â€¡Ã˜Â§ Ã™Ë† Ã™â€ Ã™â€¦Ã™Ë†Ã˜Â¯Ã˜Â§Ã˜Â± Ã˜Â¨Ã˜Â¨Ã›Å’Ã™â€ Ã›Å’Ã˜Â¯. Ã˜Â§ÃšÂ¯Ã˜Â± Ã‚Â«Ã˜Â§Ã˜Â±Ã˜Â²Ã˜Â´ Ã˜Â§Ã™â€¦Ã˜Â±Ã™Ë†Ã˜Â²Ã‚Â» Ã™â€¦Ã˜Â«Ã˜Â¨Ã˜Âª Ã˜Â¨Ã˜Â§Ã˜Â´Ã˜Â¯Ã˜Å’ Ã™â€¦Ã˜Â¹Ã™â€¦Ã™Ë†Ã™â€žÃ˜Â§Ã™â€¹ Ã˜Â·Ã˜Â±Ã˜Â­ Ã˜Â®Ã™Ë†Ã˜Â¨ Ã˜Â§Ã˜Â³Ã˜Âª.</div>
              </div>
            </div>
            <div className="flex items-center gap-2 flex-wrap">
              <button className="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white" onClick={()=>setSimple(v=>!v)}>Ã˜Â­Ã˜Â§Ã™â€žÃ˜Âª {simple? 'Ã™Â¾Ã›Å’Ã˜Â´Ã˜Â±Ã™ÂÃ˜ÂªÃ™â€¡' : 'Ã˜Â³Ã˜Â§Ã˜Â¯Ã™â€¡'}</button>
              <button onClick={downloadCSV} className="px-4 py-2 rounded-xl bg-neutral-800 border border-neutral-700 hover:bg-neutral-700 text-gray-100">Ã˜Â¯Ã˜Â§Ã™â€ Ã™â€žÃ™Ë†Ã˜Â¯ CSV</button>
              <button onClick={()=>saveScenario(s)} className="px-4 py-2 rounded-xl bg-neutral-800 border border-neutral-700 hover:bg-neutral-700 text-gray-100">Ã˜Â°Ã˜Â®Ã›Å’Ã˜Â±Ã™â€¡ Ã˜Â³Ã™â€ Ã˜Â§Ã˜Â±Ã›Å’Ã™Ë†</button>
              <button onClick={()=>{const link=prompt("Ã™â€žÃ›Å’Ã™â€ ÃšÂ© Ã˜Â³Ã™â€ Ã˜Â§Ã˜Â±Ã›Å’Ã™Ë† Ã˜Â±Ã˜Â§ Ã™Ë†Ã˜Â§Ã˜Â±Ã˜Â¯ ÃšÂ©Ã™â€ Ã›Å’Ã˜Â¯:"); if(link) location.href=link;}} className="px-4 py-2 rounded-xl bg-neutral-800 border border-neutral-700 hover:bg-neutral-700 text-gray-100">Ã˜Â¨Ã˜Â§Ã˜Â² ÃšÂ©Ã˜Â±Ã˜Â¯Ã™â€  Ã˜Â§Ã˜Â² Ã™â€žÃ›Å’Ã™â€ ÃšÂ©</button>
            </div>
          </header>

          <main className="max-w-7xl mx-auto space-y-6 md:space-y-8">
            <section className="bg-neutral-950/60 border border-neutral-800 rounded-2xl p-4 md:p-6 shadow-xl">
              <h2 className="text-emerald-400 text-base md:text-lg font-bold mb-3">Ã›Â°) Ã™â€¦Ã™â€ Ã˜Â·Ã™â€šÃ™â€¡ Ã™Ë† Ã˜Â´Ã˜Â±Ã˜Â§Ã›Å’Ã˜Â· Ã™â€¦Ã˜Â­Ã™â€žÃ›Å’</h2>
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                <Select label="Ã™â€¦Ã™â€ Ã˜Â·Ã™â€šÃ™â€¡" value={s.region} onChange={(v)=>set("region", v)} options={Object.entries(regions).map(([k,v])=>({value:k,label:v.title}))} />
                <Select label="Ã™â€¦Ã˜Â­Ã˜ÂµÃ™Ë†Ã™â€ž" value={s.crop_type} onChange={(v)=>set("crop_type", v)} options={Object.keys(cropProfiles).map(k=>({value:k,label:k}))} />
                <Select label="Ã™â€¦Ã™â€ Ã˜Â¨Ã˜Â¹ Ã˜Â¢Ã˜Â¨" value={s.water_source} onChange={(v)=>set("water_source", v)} options={Object.entries(waterSources).map(([k,v])=>({value:k,label:v.title}))} />
                <Select label="ÃšÂ¯Ã˜Â±Ã˜Â¯ Ã™Ë† Ã˜ÂºÃ˜Â¨Ã˜Â§Ã˜Â±" value={s.dust_level} onChange={(v)=>set("dust_level", v)} options={Object.entries(dustLevels).map(([k,v])=>({value:k,label:v.title}))} />
                <Select label="Ã™â€ Ã™Ë†Ã˜Â¹ Ã˜Â®Ã˜Â§ÃšÂ©" value={s.soil_type} onChange={(v)=>set("soil_type", v)} options={Object.entries(soils).map(([k,v])=>({value:k,label:v.title}))} />
                <NumberInput label="Ã˜Â´Ã™Ë†Ã˜Â±Ã›Å’ Ã˜Â¢Ã˜Â¨/Ã˜Â®Ã˜Â§ÃšÂ© (EC dS/m)" value={s.salinity_EC} onChange={(v)=>set("salinity_EC", v)} step={0.5} />
              </div>
              <p className="text-xs text-gray-400 mt-3">* Ã˜Â§ÃšÂ¯Ã˜Â± Ã™â€¦Ã™â€ Ã˜Â·Ã™â€šÃ™â€¡ Ã˜Â¯Ã™â€šÃ›Å’Ã™â€š Ã˜Â´Ã™â€¦Ã˜Â§ Ã˜Â¯Ã˜Â± Ã™â€žÃ›Å’Ã˜Â³Ã˜Âª Ã™â€ Ã›Å’Ã˜Â³Ã˜ÂªÃ˜Å’ Ã™â€ Ã˜Â²Ã˜Â¯Ã›Å’ÃšÂ©Ã¢â‚¬Å’Ã˜ÂªÃ˜Â±Ã›Å’Ã™â€  Ã™â€¦Ã™â€ Ã˜Â·Ã™â€šÃ™â€¡ Ã˜Â±Ã˜Â§ Ã˜Â§Ã™â€ Ã˜ÂªÃ˜Â®Ã˜Â§Ã˜Â¨ ÃšÂ©Ã™â€ Ã›Å’Ã˜Â¯ Ã™Ë† Ã˜Â§Ã˜Â¹Ã˜Â¯Ã˜Â§Ã˜Â¯ Ã˜Â±Ã˜Â§ ÃšÂ©Ã™â€¦Ã›Å’ Ã˜ÂªÃ™â€ Ã˜Â¸Ã›Å’Ã™â€¦ ÃšÂ©Ã™â€ Ã›Å’Ã˜Â¯.</p>
            </section>

            <div className="grid md:grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4">
              <KPI title="Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â§Ã™Ë†Ã™â€žÃ›Å’Ã™â€¡ Ã˜Â³Ã˜Â§Ã˜Â®Ã˜Âª" value={fmtMoney(capex_total)} sub="Ã™Â¾Ã™â€ Ã™â€žÃ˜Å’ Ã˜Â³Ã˜Â§Ã˜Â²Ã™â€¡Ã˜Å’ Ã˜Â§Ã›Å’Ã™â€ Ã™Ë†Ã˜Â±Ã˜ÂªÃ˜Â±Ã˜Å’ Ã˜Â§Ã˜ÂªÃ˜ÂµÃ˜Â§Ã™â€ž" />
              <KPI title="Ã˜Â¨Ã˜Â±Ã™â€š Ã˜Â³Ã˜Â§Ã™â€ž Ã˜Â§Ã™Ë†Ã™â€ž" value={`${fmt(totalPVkWhYear1)} kWh`} sub="Ã™Â¾Ã˜Â³ Ã˜Â§Ã˜Â² ÃšÂ©Ã˜Â«Ã›Å’Ã™ÂÃ›Å’/Ã˜Â®Ã˜Â±Ã˜Â§Ã˜Â¨Ã›Å’" />
              <KPI title="Ã˜Â¯Ã˜Â±Ã˜Â¢Ã™â€¦Ã˜Â¯/Ã˜ÂµÃ˜Â±Ã™ÂÃ™â€¡Ã¢â‚¬Å’Ã˜Â¬Ã™Ë†Ã›Å’Ã›Å’ Ã˜Â¨Ã˜Â±Ã™â€š Ã˜Â³Ã˜Â§Ã™â€ž Ã˜Â§Ã™Ë†Ã™â€ž" value={fmtMoney(elecRevenueYear(0))} sub="Ã˜Â·Ã˜Â¨Ã™â€š Ã˜Â·Ã˜Â±Ã˜Â­ Ã˜Â§Ã™â€ Ã˜ÂªÃ˜Â®Ã˜Â§Ã˜Â¨Ã›Å’" />
              <KPI title="Ã˜Â§Ã˜Â±Ã˜Â²Ã˜Â´ Ã˜Â§Ã™â€¦Ã˜Â±Ã™Ë†Ã˜Â² Ã˜Â³Ã™Ë†Ã˜Â¯" value={fmtMoney(npv(s.discount_rate_pct, cashflowsIncremental))} sub={`Ã˜Â¨Ã˜Â§ Ã™â€ Ã˜Â±Ã˜Â® ${s.discount_rate_pct}%`} />
              <KPI title="Ã˜Â³Ã™Ë†Ã˜Â¯ Ã˜Â³Ã˜Â§Ã™â€žÃ˜Â§Ã™â€ Ã™â€¡ Ã˜ÂªÃ™â€šÃ˜Â±Ã›Å’Ã˜Â¨Ã›Å’" value={IRR_incremental==null? 'Ã™â€ Ã˜Â§Ã™â€¦Ã˜Â´Ã˜Â®Ã˜Âµ' : `${(IRR_incremental*100).toFixed(1)} %`} sub="Ã™â€¡Ã˜Â±Ãšâ€ Ã™â€¡ Ã˜Â¨Ã›Å’Ã˜Â´Ã˜ÂªÃ˜Â±Ã˜Å’ Ã˜Â¨Ã™â€¡Ã˜ÂªÃ˜Â±" />
            </div>

            <div className={`rounded-2xl p-4 border shadow-xl ${decisionText()==='Ã˜Â¨Ã™â€¡Ã¢â‚¬Å’Ã˜ÂµÃ˜Â±Ã™ÂÃ™â€¡' ? 'bg-emerald-900/30 border-emerald-700' : decisionText()==='Ã˜ÂªÃ™â€šÃ˜Â±Ã›Å’Ã˜Â¨Ã˜Â§Ã™â€¹ Ã˜Â³Ã˜Â± Ã˜Â¨Ã™â€¡ Ã˜Â³Ã˜Â±' ? 'bg-yellow-900/30 border-yellow-700' : 'bg-rose-900/30 border-rose-700'}`}>
              <div className="text-sm">Ã˜Â®Ã™â€žÃ˜Â§Ã˜ÂµÃ™â€¡ Ã˜ÂªÃ˜ÂµÃ™â€¦Ã›Å’Ã™â€¦:</div>
              <div className="text-lg font-bold mt-1">{decisionText()}</div>
              <div className="text-xs text-gray-300 mt-1">Ã˜Â§ÃšÂ¯Ã˜Â± Ã‚Â«Ã˜Â§Ã˜Â±Ã˜Â²Ã˜Â´ Ã˜Â§Ã™â€¦Ã˜Â±Ã™Ë†Ã˜Â²Ã‚Â» Ã™â€¦Ã˜Â«Ã˜Â¨Ã˜Âª Ã˜Â¨Ã˜Â§Ã˜Â´Ã˜Â¯ Ã™Ë† Ã˜Â¨Ã˜Â§Ã˜Â²ÃšÂ¯Ã˜Â´Ã˜Âª Ã˜Â³Ã˜Â±Ã™â€¦Ã˜Â§Ã›Å’Ã™â€¡ Ã˜Â¯Ã˜Â± Ãšâ€ Ã™â€ Ã˜Â¯ Ã˜Â³Ã˜Â§Ã™â€ž Ã˜Â§Ã™Ë†Ã™â€ž Ã˜Â±Ã˜Â® Ã˜Â¯Ã™â€¡Ã˜Â¯Ã˜Å’ Ã™â€¦Ã˜Â¹Ã™â€¦Ã™Ë†Ã™â€žÃ˜Â§Ã™â€¹ Ã˜Â·Ã˜Â±Ã˜Â­ Ã˜Â§Ã™â€šÃ˜ÂªÃ˜ÂµÃ˜Â§Ã˜Â¯Ã›Å’ Ã˜Â§Ã˜Â³Ã˜Âª.</div>
            </div>

            <Section title="Ã›Â±) Ã˜Â§Ã˜Â·Ã™â€žÃ˜Â§Ã˜Â¹Ã˜Â§Ã˜Âª Ã˜Â²Ã™â€¦Ã›Å’Ã™â€  Ã™Ë† Ã™â€¦Ã˜Â­Ã˜ÂµÃ™Ë†Ã™â€ž">
              <NumberInput label="Ã™â€¦Ã˜Â³Ã˜Â§Ã˜Â­Ã˜Âª Ã˜Â²Ã™â€¦Ã›Å’Ã™â€  (Ã™â€¡ÃšÂ©Ã˜ÂªÃ˜Â§Ã˜Â±)" value={s.project_area_ha} onChange={(v)=>set("project_area_ha", v)} step={0.1} />
              <NumberInput label="Ã˜Â¹Ã™â€¦Ã™â€žÃšÂ©Ã˜Â±Ã˜Â¯ Ã™ÂÃ˜Â¹Ã™â€žÃ›Å’ (Ã˜ÂªÃ™â€ /Ã™â€¡ÃšÂ©Ã˜ÂªÃ˜Â§Ã˜Â±)" value={s.baseline_yield_t_per_ha} onChange={(v)=>set("baseline_yield_t_per_ha", v)} step={0.1} />
              <NumberInput label="Ã˜ÂªÃ˜ÂºÃ›Å’Ã›Å’Ã˜Â± Ã˜Â¹Ã™â€¦Ã™â€žÃšÂ©Ã˜Â±Ã˜Â¯ Ã˜Â²Ã›Å’Ã˜Â± Ã™Â¾Ã™â€ Ã™â€ž (%)" value={s.expected_yield_change_pct_under_AGV} onChange={(v)=>set("expected_yield_change_pct_under_AGV", v)} step={0.5} />
              <NumberInput label="Ã™â€šÃ›Å’Ã™â€¦Ã˜Âª Ã™ÂÃ˜Â±Ã™Ë†Ã˜Â´ Ã™â€¦Ã˜Â­Ã˜ÂµÃ™Ë†Ã™â€ž (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/Ã˜ÂªÃ™â€ )" value={s.crop_price_per_t} onChange={(v)=>set("crop_price_per_t", v)} step={1000000} />
              <NumberInput label="Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â³Ã˜Â§Ã™â€žÃ˜Â§Ã™â€ Ã™â€¡ ÃšÂ©Ã˜Â´Ã˜Â§Ã™Ë†Ã˜Â±Ã˜Â²Ã›Å’ (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/Ã™â€¡ÃšÂ©Ã˜ÂªÃ˜Â§Ã˜Â±)" value={s.ag_opex_baseline_per_ha} onChange={(v)=>set("ag_opex_baseline_per_ha", v)} step={1000000} />
              <NumberInput label="Ã˜ÂªÃ˜ÂºÃ›Å’Ã›Å’Ã˜Â± Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ ÃšÂ©Ã˜Â´Ã˜Â§Ã™Ë†Ã˜Â±Ã˜Â²Ã›Å’ (%)" value={s.ag_opex_change_under_AGV_pct} onChange={(v)=>set("ag_opex_change_under_AGV_pct", v)} step={0.5} />
              <NumberInput label="Ã™â€¦Ã˜ÂµÃ˜Â±Ã™Â Ã˜Â¢Ã˜Â¨ Ã™ÂÃ˜Â¹Ã™â€žÃ›Å’ (mÃ‚Â³/Ã™â€¡ÃšÂ©Ã˜ÂªÃ˜Â§Ã˜Â±)" value={s.water_use_baseline_m3_per_ha} onChange={(v)=>set("water_use_baseline_m3_per_ha", v)} step={10} />
              <NumberInput label="Ã˜ÂªÃ˜ÂºÃ›Å’Ã›Å’Ã˜Â± Ã™â€¦Ã˜ÂµÃ˜Â±Ã™Â Ã˜Â¢Ã˜Â¨ (%)" value={s.water_use_change_under_AGV_pct} onChange={(v)=>set("water_use_change_under_AGV_pct", v)} step={1} />
              <NumberInput label="Ã˜Â´Ã›Å’Ã˜Â±Ã›Å’Ã™â€ Ã›Å’/Ã˜ÂªÃ™â€žÃ˜Â®Ã›Å’ Ã™â€šÃ›Å’Ã™â€¦Ã˜Âª (ÃšÂ©Ã›Å’Ã™ÂÃ›Å’Ã˜Âª) (%)" value={s.crop_quality_premium_or_discount_pct} onChange={(v)=>set("crop_quality_premium_or_discount_pct", v)} step={0.5} />
            </Section>

            <Section title="Ã›Â²) Ã˜Â¢Ã˜Â¨Ã›Å’Ã˜Â§Ã˜Â±Ã›Å’ Ã™Ë† Ã˜Â¨Ã˜Â±Ã™â€š Ã™â€¦Ã˜Â²Ã˜Â±Ã˜Â¹Ã™â€¡">
              <NumberInput label="Ã˜Â¨Ã˜Â±Ã™â€š Ã™Â¾Ã™â€¦Ã™Â¾Ã˜Â§ÃšËœ Ã˜Â¢Ã˜Â¨ (kWh Ã˜Â¨Ã˜Â±Ã˜Â§Ã›Å’ Ã™â€¡Ã˜Â± mÃ‚Â³)" value={s.energy_for_irrigation_kWh_per_m3} onChange={(v)=>set("energy_for_irrigation_kWh_per_m3", v)} step={0.01} />
              <NumberInput label="Ã™â€šÃ›Å’Ã™â€¦Ã˜Âª Ã˜Â¨Ã˜Â±Ã™â€š Ã˜Â¨Ã˜Â±Ã˜Â§Ã›Å’ Ã™Â¾Ã™â€¦Ã™Â¾Ã˜Â§ÃšËœ (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/kWh)" value={s.irrigation_energy_tariff || 0} onChange={(v)=>set("irrigation_energy_tariff", v)} step={50} />
              <NumberInput label="Ã™â€šÃ›Å’Ã™â€¦Ã˜Âª Ã˜Â¢Ã˜Â¨ Ã˜Â®Ã˜Â±Ã›Å’Ã˜Â¯Ã˜Â§Ã˜Â±Ã›Å’Ã¢â‚¬Å’Ã˜Â´Ã˜Â¯Ã™â€¡ (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/mÃ‚Â³)" value={s.water_unit_cost} onChange={(v)=>set("water_unit_cost", v)} step={100} />
              <Select label="Ã˜Â·Ã˜Â±Ã˜Â­ Ã™â€¦Ã˜ÂµÃ˜Â±Ã™Â/Ã™ÂÃ˜Â±Ã™Ë†Ã˜Â´ Ã˜Â¨Ã˜Â±Ã™â€š" value={s.grid_scheme} onChange={(v)=>set("grid_scheme", v)} options={[{value:"PPA/FIT",label:"Ã™ÂÃ˜Â±Ã™Ë†Ã˜Â´ Ã˜ÂªÃ˜Â¶Ã™â€¦Ã›Å’Ã™â€ Ã›Å’"},{value:"NetMetering",label:"Ã˜ÂªÃ˜Â±Ã˜Â§Ã˜Â² Ã˜Â¨Ã˜Â§ Ã˜Â´Ã˜Â¨ÃšÂ©Ã™â€¡"},{value:"SelfConsumption",label:"Ã™â€¦Ã˜ÂµÃ˜Â±Ã™Â Ã˜Â¯Ã˜Â± Ã™â€¦Ã˜Â²Ã˜Â±Ã˜Â¹Ã™â€¡"}]} />
              <NumberInput label="Ã™â€šÃ›Å’Ã™â€¦Ã˜Âª Ã˜ÂªÃ˜Â¶Ã™â€¦Ã›Å’Ã™â€ Ã›Å’/Ã™ÂÃ˜Â±Ã™Ë†Ã˜Â´ (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/kWh)" value={s.ppa_or_fit_tariff} onChange={(v)=>set("ppa_or_fit_tariff", v)} step={50} />
              <NumberInput label="Ã˜Â³Ã™â€¡Ã™â€¦ Ã™â€¦Ã˜ÂµÃ˜Â±Ã™Â Ã˜Â¯Ã˜Â± Ã™â€¦Ã˜Â²Ã˜Â±Ã˜Â¹Ã™â€¡ (%)" value={s.self_consumption_share_pct} onChange={(v)=>set("self_consumption_share_pct", v)} step={1} />
              <NumberInput label="Ã™â€šÃ›Å’Ã™â€¦Ã˜Âª Ã˜Â®Ã˜Â±Ã›Å’Ã˜Â¯ Ã˜Â§Ã˜Â² Ã˜Â´Ã˜Â¨ÃšÂ©Ã™â€¡ (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/kWh)" value={s.net_metering_buy_price} onChange={(v)=>set("net_metering_buy_price", v)} step={50} />
              <NumberInput label="Ã™â€šÃ›Å’Ã™â€¦Ã˜Âª Ã™ÂÃ˜Â±Ã™Ë†Ã˜Â´ Ã˜Â¨Ã™â€¡ Ã˜Â´Ã˜Â¨ÃšÂ©Ã™â€¡ (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/kWh)" value={s.net_metering_sell_price} onChange={(v)=>set("net_metering_sell_price", v)} step={50} />
            </Section>

            <Section title="Ã›Â³) Ã˜Â¨Ã˜Â±Ã™â€š Ã˜Â®Ã™Ë†Ã˜Â±Ã˜Â´Ã›Å’Ã˜Â¯Ã›Å’ (Ã˜Â§Ã™â€ Ã˜Â¯Ã˜Â§Ã˜Â²Ã™â€¡ Ã™Ë† Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â³Ã˜Â§Ã˜Â®Ã˜Âª)">
              <NumberInput label="Ã˜Â¸Ã˜Â±Ã™ÂÃ›Å’Ã˜Âª ÃšÂ©Ã™â€ž Ã˜Â³Ã˜Â§Ã™â€¦Ã˜Â§Ã™â€ Ã™â€¡ (kWp)" value={s.pv_capacity_kWp_total} onChange={(v)=>set("pv_capacity_kWp_total", v)} />
              <NumberInput label="Ã˜ÂªÃ™Ë†Ã™â€žÃ›Å’Ã˜Â¯ Ã™Ë†Ã›Å’ÃšËœÃ™â€¡ Ã˜Â³Ã˜Â§Ã™â€žÃ˜Â§Ã™â€ Ã™â€¡ (kWh/kWp)" value={s.specific_yield_kWh_per_kWp_year} onChange={(v)=>set("specific_yield_kWh_per_kWp_year", v)} step={10} />
              <NumberInput label="Ã™â€šÃ›Å’Ã™â€¦Ã˜Âª Ã™Â¾Ã™â€ Ã™â€ž (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/kWp)" value={s.module_price_per_kWp} onChange={(v)=>set("module_price_per_kWp", v)} step={1000000} />
              <NumberInput label="Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â³Ã˜Â§Ã˜Â²Ã™â€¡ (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/kWp)" value={s.mounting_structure_cost_per_kWp} onChange={(v)=>set("mounting_structure_cost_per_kWp", v)} step={1000000} />
              <NumberInput label="Ã˜Â§Ã›Å’Ã™â€ Ã™Ë†Ã˜Â±Ã˜ÂªÃ˜Â± Ã™Ë† ÃšÂ©Ã˜Â§Ã˜Â¨Ã™â€žÃ¢â‚¬Å’ÃšÂ©Ã˜Â´Ã›Å’ (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/kWp)" value={s.inverter_BOS_cost_per_kWp} onChange={(v)=>set("inverter_BOS_cost_per_kWp", v)} step={1000000} />
              <NumberInput label="Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â§Ã˜ÂªÃ˜ÂµÃ˜Â§Ã™â€ž Ã˜Â¨Ã™â€¡ Ã˜Â´Ã˜Â¨ÃšÂ©Ã™â€¡ (Ã›Å’ÃšÂ©Ã˜Â¬Ã˜Â§)" value={s.grid_interconnection_lump_sum} onChange={(v)=>set("grid_interconnection_lump_sum", v)} step={1000000} />
              {!simple && <>
                <NumberInput label="Ã˜Â®Ã˜Â¯Ã™â€¦Ã˜Â§Ã˜Âª/Ã™â€¦Ã˜Â¬Ã™Ë†Ã˜Â²/Ã˜Â·Ã˜Â±Ã˜Â§Ã˜Â­Ã›Å’ (%)" value={s.EPC_soft_cost_pct_of_capex} onChange={(v)=>set("EPC_soft_cost_pct_of_capex", v)} step={0.5} />
                <NumberInput label="ÃšÂ©Ã˜Â§Ã™â€¡Ã˜Â´ Ã˜Â±Ã˜Â§Ã™â€ Ã˜Â¯Ã™â€¦Ã˜Â§Ã™â€  Ã™Â¾Ã™â€ Ã™â€ž (% Ã˜Â³Ã˜Â§Ã™â€žÃ˜Â§Ã™â€ Ã™â€¡)" value={s.annual_pv_degradation_pct} onChange={(v)=>set("annual_pv_degradation_pct", v)} step={0.1} />
                <NumberInput label="ÃšÂ©Ã˜Â«Ã›Å’Ã™ÂÃ›Å’ Ã™Â¾Ã™â€ Ã™â€ž (Ã™Âª)" value={s.soiling_loss_pct} onChange={(v)=>set("soiling_loss_pct", v)} step={0.5} />
                <NumberInput label="Ã˜Â¯Ã˜Â³Ã˜ÂªÃ˜Â±Ã˜Â³Ã¢â‚¬Å’Ã™Â¾Ã˜Â°Ã›Å’Ã˜Â±Ã›Å’ Ã˜Â³Ã˜Â§Ã™â€¦Ã˜Â§Ã™â€ Ã™â€¡ (Ã™Âª)" value={s.availability_pct} onChange={(v)=>set("availability_pct", v)} step={0.5} />
                <NumberInput label="Ã™â€ ÃšÂ¯Ã™â€¡Ã˜Â¯Ã˜Â§Ã˜Â±Ã›Å’ Ã˜Â³Ã˜Â§Ã™â€žÃ˜Â§Ã™â€ Ã™â€¡ (Ã˜Â±Ã›Å’Ã˜Â§Ã™â€ž/kWp)" value={s.pv_om_cost_per_kWp_year} onChange={(v)=>set("pv_om_cost_per_kWp_year", v)} step={10000} />
              </>}
            </Section>

            <section className="bg-neutral-950/60 border border-neutral-800 rounded-2xl p-4 md:p-6 shadow-xl">
              <h2 className="text-emerald-400 text-base md:text-lg font-bold mb-3">Ã™â€ Ã˜ÂªÃ˜Â§Ã›Å’Ã˜Â¬ Ã˜Â®Ã™â€žÃ˜Â§Ã˜ÂµÃ™â€¡</h2>
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                <KV k="Ã˜Â¯Ã˜Â±Ã˜Â¢Ã™â€¦Ã˜Â¯ ÃšÂ©Ã˜Â´Ã˜Â§Ã™Ë†Ã˜Â±Ã˜Â²Ã›Å’ (Ã™â€šÃ˜Â¨Ã™â€ž Ã˜Â§Ã˜Â² Ã™Â¾Ã™â€ Ã™â€ž)" v={fmtMoney(ag_rev_baseline)} />
                <KV k="Ã˜Â¯Ã˜Â±Ã˜Â¢Ã™â€¦Ã˜Â¯ ÃšÂ©Ã˜Â´Ã˜Â§Ã™Ë†Ã˜Â±Ã˜Â²Ã›Å’ (Ã˜Â¨Ã˜Â§ Ã™Â¾Ã™â€ Ã™â€ž)" v={fmtMoney(ag_rev_agv)} />
                <KV k="Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â¢Ã˜Â¨ (Ã™â€šÃ˜Â¨Ã™â€ž)" v={fmtMoney(water_cost_base)} />
                <KV k="Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â¢Ã˜Â¨ (Ã˜Â¨Ã˜Â§ Ã™Â¾Ã™â€ Ã™â€ž)" v={fmtMoney(water_cost_agv)} />
                <KV k="Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â§Ã™â€ Ã˜Â±ÃšËœÃ›Å’ Ã™Â¾Ã™â€¦Ã™Â¾Ã˜Â§ÃšËœ (Ã™â€šÃ˜Â¨Ã™â€ž)" v={fmtMoney(irrigation_energy_cost_base)} />
                <KV k="Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â§Ã™â€ Ã˜Â±ÃšËœÃ›Å’ Ã™Â¾Ã™â€¦Ã™Â¾Ã˜Â§ÃšËœ (Ã˜Â¨Ã˜Â§ Ã™Â¾Ã™â€ Ã™â€ž)" v={fmtMoney(irrigation_energy_cost_agv)} />
                <KV k="Ã™â€ ÃšÂ¯Ã™â€¡Ã˜Â¯Ã˜Â§Ã˜Â±Ã›Å’ Ã˜Â³Ã˜Â§Ã™â€žÃ˜Â§Ã™â€ Ã™â€¡ Ã˜Â³Ã˜Â§Ã™â€¦Ã˜Â§Ã™â€ Ã™â€¡ Ã˜Â®Ã™Ë†Ã˜Â±Ã˜Â´Ã›Å’Ã˜Â¯Ã›Å’" v={fmtMoney(pv_om_annual)} />
                <KV k="Ã˜Â¨Ã›Å’Ã™â€¦Ã™â€¡ Ã˜Â³Ã˜Â§Ã™â€žÃ˜Â§Ã™â€ Ã™â€¡" v={fmtMoney(insurance_annual)} />
              </div>
            </section>

            <div className="grid lg:grid-cols-2 gap-4">
              <Chart title="Ã˜Â¬Ã˜Â±Ã›Å’Ã˜Â§Ã™â€  Ã™â€ Ã™â€šÃ˜Â¯Ã›Å’ Ã˜Â§Ã™ÂÃ˜Â²Ã˜Â§Ã›Å’Ã˜Â´Ã›Å’ Ã™â€¡Ã˜Â± Ã˜Â³Ã˜Â§Ã™â€ž" data={cashflowsIncremental.slice(1)} />
              {(()=>{const cum=[];let c=0;for(let i=0;i<cashflowsIncremental.length;i++){c+=cashflowsIncremental[i];cum.push(c);}return <Chart title="Ã˜Â¬Ã™â€¦Ã˜Â¹Ã™Â Ã˜Â¬Ã˜Â±Ã›Å’Ã˜Â§Ã™â€  Ã™â€ Ã™â€šÃ˜Â¯Ã›Å’ Ã˜Â§Ã˜Â² Ã˜Â´Ã˜Â±Ã™Ë†Ã˜Â¹ Ã™Â¾Ã˜Â±Ã™Ë†ÃšËœÃ™â€¡" data={cum} />;})()}
            </div>

            <section className="bg-neutral-950/60 border border-neutral-800 rounded-2xl p-4 md:p-6 shadow-xl overflow-x-auto">
              <h2 className="text-emerald-400 text-base md:text-lg font-bold mb-4">Ã˜Â¬Ã˜Â¯Ã™Ë†Ã™â€ž Ã˜Â³Ã˜Â§Ã™â€žÃ¢â‚¬Å’Ã˜Â¨Ã™â€¡Ã¢â‚¬Å’Ã˜Â³Ã˜Â§Ã™â€ž</h2>
              <table className="w-full text-sm">
                <thead className="text-gray-300">
                  <tr className="border-b border-neutral-800">
                    <th className="py-2 text-right">Ã˜Â³Ã˜Â§Ã™â€ž</th>
                    <th className="py-2 text-right">Ã˜Â¨Ã˜Â±Ã™â€š (kWh)</th>
                    <th className="py-2 text-right">Ã˜Â¯Ã˜Â±Ã˜Â¢Ã™â€¦Ã˜Â¯/Ã˜ÂµÃ˜Â±Ã™ÂÃ™â€¡Ã¢â‚¬Å’Ã˜Â¬Ã™Ë†Ã›Å’Ã›Å’ Ã˜Â¨Ã˜Â±Ã™â€š</th>
                    <th className="py-2 text-right">Ã˜Â®Ã˜Â§Ã™â€žÃ˜Âµ ÃšÂ©Ã˜Â´Ã˜Â§Ã™Ë†Ã˜Â±Ã˜Â²Ã›Å’ (Ã™â€šÃ˜Â¨Ã™â€ž)</th>
                    <th className="py-2 text-right">Ã˜Â®Ã˜Â§Ã™â€žÃ˜Âµ ÃšÂ©Ã˜Â´Ã˜Â§Ã™Ë†Ã˜Â±Ã˜Â²Ã›Å’ (Ã˜Â¨Ã˜Â§ Ã™Â¾Ã™â€ Ã™â€ž)</th>
                    <th className="py-2 text-right">Ã˜Â§Ã™ÂÃ˜Â²Ã˜Â§Ã›Å’Ã˜Â´Ã›Å’</th>
                  </tr>
                </thead>
                <tbody>
                  {cashflowsAGV.map((_, i) => (
                    <tr key={i} className="border-b border-neutral-900 hover:bg-neutral-900/40">
                      <td className="py-2">{i+1}</td>
                      <td className="py-2">{fmt(annualPV(i))}</td>
                      <td className="py-2">{fmtMoney(elecRevenueYear(i) + carbonRevenueYear(i))}</td>
                      <td className="py-2">{fmtMoney(cashflowsBaseline[i])}</td>
                      <td className="py-2">{fmtMoney(cashflowsAGV[i])}</td>
                      <td className="py-2">{fmtMoney(cashflowsIncremental[i+1] ?? 0)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="mt-4 text-xs text-gray-400">* Ã˜Â³Ã˜Â§Ã™â€ž Ã˜ÂµÃ™ÂÃ˜Â± Ã˜Â´Ã˜Â§Ã™â€¦Ã™â€ž Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â³Ã˜Â§Ã˜Â®Ã˜Âª Ã˜Â§Ã˜Â³Ã˜Âª Ã™Ë† Ã˜Â¯Ã˜Â± Ã˜Â¬Ã˜Â¯Ã™Ë†Ã™â€ž Ã™â€ Ã›Å’Ã˜Â§Ã™â€¦Ã˜Â¯Ã™â€¡ Ã˜Â§Ã˜Â³Ã˜Âª.</div>
            </section>

            <div className="text-xs text-gray-400 pb-8">
              Ã™â€ ÃšÂ©Ã˜ÂªÃ™â€¡: Ã˜Â¨Ã˜Â±Ã˜Â§Ã›Å’ Ã˜Â¯Ã™â€šÃ˜Âª Ã˜Â¨Ã›Å’Ã˜Â´Ã˜ÂªÃ˜Â±Ã˜Å’ Ã™â€šÃ›Å’Ã™â€¦Ã˜Âª Ã™â€¦Ã˜Â­Ã˜ÂµÃ™Ë†Ã™â€ž Ã™Ë† Ã™â€¡Ã˜Â²Ã›Å’Ã™â€ Ã™â€¡ Ã˜Â¢Ã˜Â¨/Ã˜Â¨Ã˜Â±Ã™â€š Ã˜Â±Ã˜Â§ Ã˜Â§Ã˜Â² Ã™ÂÃ›Å’Ã˜Â´Ã¢â‚¬Å’Ã™â€¡Ã˜Â§Ã›Å’ Ã˜Â§Ã˜Â®Ã›Å’Ã˜Â± Ã˜Â®Ã™Ë†Ã˜Â¯Ã˜ÂªÃ˜Â§Ã™â€  Ã™Ë†Ã˜Â§Ã˜Â±Ã˜Â¯ ÃšÂ©Ã™â€ Ã›Å’Ã˜Â¯. Ã˜Â§ÃšÂ¯Ã˜Â± Ã˜Â®Ã™Ë†Ã˜Â§Ã˜Â³Ã˜ÂªÃ›Å’Ã˜Â¯Ã˜Å’ Ã™â€¦Ã›Å’Ã¢â‚¬Å’Ã˜ÂªÃ™Ë†Ã˜Â§Ã™â€ Ã›Å’Ã™â€¦ Ã™â€ Ã˜Â³Ã˜Â®Ã™â€¡ Ã˜Â±Ã™Ë†Ã˜Â³Ã˜ÂªÃ˜Â§Ã›Å’Ã›Å’/Ã˜Â¯Ã™â€¡Ã˜Â³Ã˜ÂªÃ˜Â§Ã™â€ Ã›Å’ Ã˜Â¨Ã˜Â§ Ã˜Â§Ã˜Â¹Ã˜Â¯Ã˜Â§Ã˜Â¯ Ã˜Â¯Ã™â€šÃ›Å’Ã™â€šÃ¢â‚¬Å’Ã˜ÂªÃ˜Â±Ã›Å’ Ã˜Â¨Ã˜Â³Ã˜Â§Ã˜Â²Ã›Å’Ã™â€¦.
            </div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AgrivoltaicsKhorasan/>);
  </script>
  <script charset="utf-8" type="module">
    import { apiFetch } from '/assets/js/api.js';

    async function runSelfTest() {
      console.info('[selftest]', 'starting');
      try {
        const healthRes = await apiFetch('/api/health');
        if (!healthRes.ok) {
          const text = await healthRes.text();
          throw new Error(`health status ${healthRes.status}: ${text}`);
        }
        const healthJson = await healthRes.json();
        console.info('[selftest]', 'health', healthJson);

        const payload = {
          nodes: [
            { id: 'n1', label: 'Demand' },
            { id: 'n2', label: 'Supply' }
          ],
          edges: [
            { source: 'n1', target: 'n2', sign: 'plus' }
          ],
          meta: { model_id: 'ui-selftest' }
        };

        const submitRes = await apiFetch('/api/submit', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!submitRes.ok) {
          const text = await submitRes.text();
          throw new Error(`submit status ${submitRes.status}: ${text}`);
        }

        const submitJson = await submitRes.json();
        const jobId = submitJson?.job_id;
        if (!jobId) {
          throw new Error('missing job_id in submit response');
        }
        console.info('[selftest]', 'submitted', jobId);

        const deadline = Date.now() + 30000;
        while (Date.now() < deadline) {
          const pollRes = await apiFetch(`/api/result/${encodeURIComponent(jobId)}`);
          if (!pollRes.ok) {
            const text = await pollRes.text();
            throw new Error(`poll status ${pollRes.status}: ${text}`);
          }

          const pollJson = await pollRes.json();
          if (pollJson?.summary) {
            console.info('[selftest]', 'done', pollJson.summary);
            return pollJson.summary;
          }

          if (typeof pollJson?.status === 'string' && pollJson.status.toLowerCase() === 'failed') {
            throw new Error('job failed');
          }

          await new Promise((resolve) => setTimeout(resolve, 1000));
        }

        throw new Error('timeout waiting for result');
      } catch (error) {
        console.error('[selftest]', error);
        throw error;
      }
    }

    const button = document.getElementById('btn-api-selftest');
    if (button) {
      button.addEventListener('click', async () => {
        try {
          const summary = await runSelfTest();
          console.info('[selftest]', 'summary', summary);
        } catch {
          // already logged
        }
      });
    }

    window.__apiSelfTest = runSelfTest;
  </script>
  <script charset="utf-8" defer src="/assets/unified-badge.js"></script>
  <script charset="utf-8" defer src="/assets/global-footer.js"></script>
  <script charset="utf-8" defer src="/assets/js/utf8-fix.js"></script>
</body>
</html>

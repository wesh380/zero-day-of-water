<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- ✅ Performance Optimization: DNS Prefetch & Preconnect -->
  <link rel="dns-prefetch" href="//tile.openstreetmap.org">
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
  <link rel="dns-prefetch" href="//statsfa.com">
  <link rel="dns-prefetch" href="//cdn.porsline.ir">

  <!-- ✅ Preload Leaflet for faster LCP -->
  <link rel="preload" href="/assets/vendor/leaflet/leaflet.js" as="script">

  <!-- ✅ Critical CSS: Preload for faster rendering -->
  <link rel="preload" href="/assets/css-bundles-dist/core.bundle.css" as="style">
  <link rel="preload" href="/assets/css-bundles-dist/layout.bundle.css" as="style">

  <!-- ✅ Critical CSS: Load immediately -->
  <link rel="stylesheet" href="/assets/css-bundles-dist/core.bundle.css">
  <link rel="stylesheet" href="/assets/css-bundles-dist/layout.bundle.css">

  <!-- ✅ Map CSS: Async loading to reduce render-blocking -->
  <link rel="preload" href="/assets/css/map-inline.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/assets/css/map-inline.css"></noscript>

  <!-- ✅ Non-Critical CSS: Async loading -->
  <link rel="preload" href="/assets/vendor/leaflet/leaflet.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/assets/vendor/leaflet/leaflet.css"></noscript>

  <link rel="preload" href="/assets/css/map-overrides.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/assets/css/map-overrides.css"></noscript>

  <link rel="preload" href="/assets/legend.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/assets/legend.css"></noscript>

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://wesh360.ir/amaayesh/">
  <meta property="og:title" content="نقشه آمایش انرژی خراسان رضوی">
  <meta property="og:description" content="پتانسیل باد، خورشید و آب استان">
  <meta property="og:image" content="https://wesh360.ir/page/landing/logo2.webp">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="نقشه آمایش انرژی خراسان رضوی">
  <meta name="twitter:description" content="پتانسیل باد، خورشید و آب استان">
  <meta name="twitter:image" content="https://wesh360.ir/page/landing/logo2.webp">
  <title>نقشه آمایش انرژی خراسان رضوی - پتانسیل باد، خورشید و آب | WESH360</title>
  <meta name="description" content="نقشه تعاملی آمایش انرژی خراسان رضوی - بررسی پتانسیل انرژی بادی، خورشیدی، سدها و منابع آب استان برای برنامه‌ریزی انرژی">
  <link rel="canonical" href="https://wesh360.ir/amaayesh/">
  <link rel="icon" type="image/svg+xml" href="/assets/img/logo/wesh360.svg"/>
  <link rel="alternate icon" type="image/png" sizes="32x32" href="/assets/img/logo/icons/icon-32.png"/>
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/logo/icons/icon-180.png"/>
  <link rel="manifest" href="/manifest.webmanifest"/>
  <link rel="mask-icon" href="/assets/img/logo/wesh360.svg" color="#0ea5e9"/>
  <meta name="theme-color" content="#0ea5e9"/>
  <script src="/assets/js/nav-utils.js" defer></script>
  <meta name="build-id" content="ama-20250906">

  <!-- ✅ CSS Async Loading Polyfill -->
  <script>
    /* loadCSS: Async CSS loader - https://github.com/filamentgroup/loadCSS */
    !function(e){"use strict";var t=function(t,n,r){var o,i=e.document,l=i.createElement("link");if(n)o=n;else{var a=(i.body||i.getElementsByTagName("head")[0]).childNodes;o=a[a.length-1]}var s=i.styleSheets;l.rel="stylesheet",l.href=t,l.media="only x",function e(t){if(i.body)return t();setTimeout(function(){e(t)})}(function(){o.parentNode.insertBefore(l,n?o:o.nextSibling)});var d=function(e){for(var t=l.href,n=s.length;n--;)if(s[n].href===t)return e();setTimeout(function(){d(e)})};return l.addEventListener&&l.addEventListener("load",r),l.onloadcssdefined=d,d(r),l};"undefined"!=typeof exports?exports.loadCSS=t:e.loadCSS=t}("undefined"!=typeof global?global:this);
  </script>

  <script>
    /* Suppress Cloudflare Beacon Errors */
    window.addEventListener('error',function(e){if(e.target&&e.target.src&&(e.target.src.includes('statsfa.com')||e.target.src.includes('beacon.min.js'))){e.preventDefault();e.stopPropagation();return false;}},true);

    /* Responsive Mobile Detection */
    (function() {
      function updateMobileClass() {
        const main = document.querySelector('.ama-main');
        if (!main) return;

        if (window.innerWidth <= 768) {
          main.classList.add('is-mobile');
        } else {
          main.classList.remove('is-mobile');
        }
      }

      // Initial check
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateMobileClass);
      } else {
        updateMobileClass();
      }

      // Update on resize with debounce
      let resizeTimer;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(updateMobileClass, 250);
      });
    })();

    /* Mobile Sidebar Management */
    (function() {
      function initMobileSidebar() {
        const menuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('mobile-sidebar');
        const overlay = document.getElementById('mobile-sidebar-overlay');
        const closeBtn = document.getElementById('mobile-sidebar-close');
        const panelsContainer = document.getElementById('mobile-panels-container');
        const layerDock = document.getElementById('ama-layer-dock');

        if (!menuBtn || !sidebar || !overlay) return;

        let isMobile = false;

        function checkMobile() {
          const wasMobile = isMobile;
          isMobile = window.innerWidth <= 768;

          if (isMobile && !wasMobile) {
            // Switched to mobile - move panels to sidebar
            if (layerDock && !panelsContainer.contains(layerDock)) {
              panelsContainer.appendChild(layerDock);
            }
          } else if (!isMobile && wasMobile) {
            // Switched to desktop - move panels back
            const main = document.querySelector('.ama-main');
            if (layerDock && panelsContainer.contains(layerDock)) {
              main.appendChild(layerDock);
            }
            closeSidebar();
          }
        }

        function openSidebar() {
          sidebar.classList.add('open');
          overlay.classList.add('active');
          menuBtn.classList.add('active');
          sidebar.setAttribute('aria-hidden', 'false');
          overlay.setAttribute('aria-hidden', 'false');
          menuBtn.setAttribute('aria-expanded', 'true');
          document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
          sidebar.classList.remove('open');
          overlay.classList.remove('active');
          menuBtn.classList.remove('active');
          sidebar.setAttribute('aria-hidden', 'true');
          overlay.setAttribute('aria-hidden', 'true');
          menuBtn.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }

        function toggleSidebar() {
          if (sidebar.classList.contains('open')) {
            closeSidebar();
          } else {
            openSidebar();
          }
        }

        // Event listeners
        menuBtn.addEventListener('click', toggleSidebar);
        closeBtn?.addEventListener('click', closeSidebar);

        // ✅ بهبود یافته: بستن با کلیک روی overlay (فقط خود overlay نه محتوا)
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            closeSidebar();
          }
        });

        // ✅ افزودن Swipe برای بستن Sidebar
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;

        sidebar.addEventListener('touchstart', function(e) {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
        }, { passive: true });

        sidebar.addEventListener('touchmove', function(e) {
          touchEndX = e.touches[0].clientX;
          touchEndY = e.touches[0].clientY;
        }, { passive: true });

        sidebar.addEventListener('touchend', function(e) {
          const diffX = touchEndX - touchStartX;
          const diffY = Math.abs(touchEndY - touchStartY);

          // اگر بیش از 100px به راست swipe شد و حرکت عمودی کمتر از 50px بود
          // (برای اطمینان از اینکه swipe افقی است نه scroll عمودی)
          if (diffX > 100 && diffY < 50) {
            closeSidebar();
          }
        }, { passive: true });

        // Close on Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && sidebar.classList.contains('open')) {
            closeSidebar();
          }
        });

        // Handle resize
        checkMobile();
        let resizeTimer;
        window.addEventListener('resize', function() {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(checkMobile, 250);
        });
      }

      // Initialize after DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMobileSidebar);
      } else {
        initMobileSidebar();
      }
    })();
  </script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 flex flex-col">
  <a class="skip-link" href="#main">پرش به محتوای اصلی</a>

<main id="main" role="main" class="flex relative ama-main">
    <!-- Hamburger Menu Button (Mobile Only) -->
    <button id="mobile-menu-btn" class="mobile-menu-btn" aria-label="منو" aria-expanded="false">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>

    <!-- Mobile Sidebar -->
    <aside id="mobile-sidebar" class="mobile-sidebar" aria-hidden="true">
      <div class="mobile-sidebar-header">
        <h2 class="mobile-sidebar-title">منو</h2>
        <button id="mobile-sidebar-close" class="mobile-sidebar-close" aria-label="بستن منو">×</button>
      </div>
      <div class="mobile-sidebar-content">
        <!-- Panels will be moved here in mobile -->
        <div id="mobile-panels-container"></div>
      </div>
    </aside>

    <!-- Sidebar Overlay -->
    <div id="mobile-sidebar-overlay" class="mobile-sidebar-overlay" aria-hidden="true"></div>

    <!-- ظرف نقشه: id باید «map» بماند -->
    <div id="map"></div>

    <!-- پنل سمت راست -->
    <aside id="ama-layer-dock" class="ama-panel map-panel ama-layer-dock">
      <div class="ama-panel-header">
        <h2 class="ama-panel-title">لایه‌ها</h2>
        <button aria-label="تنظیمات" class="ama-settings-btn">⚙️</button>
      </div>
      <div class="ama-tabs">
        <button id="tab-wind"  data-layer-toggle="wind"  class="ama-tab-btn ama-tab-active">باد</button>
        <button id="tab-solar" data-layer-toggle="solar" class="ama-tab-btn ama-tab-inactive">خورشیدی</button>
        <button id="tab-dams"  data-layer-toggle="dams"  class="ama-tab-btn ama-tab-inactive">آب</button>
      </div>
      <div class="ama-checkbox-grid">
        <label data-layer-toggle="wind"><input type="checkbox"> سایت‌های بادی (انرژی)</label>
        <label data-layer-toggle="solar"><input type="checkbox"> سایت‌های خورشیدی</label>
        <label data-layer-toggle="dams"><input type="checkbox"> سد</label>
      </div>
    </aside>
  </main>

  <footer class="mt-6 py-6 text-center text-slate-400 text-xs">WESH360 ⬢ Energy Spatial Planning ⬢ Leaflet</footer>

  <!-- ✅ Eager Loading: Load Leaflet immediately for better LCP -->
  <script src="/assets/vendor/leaflet/leaflet.js" defer></script>
  <script src="/assets/js/leaflet-icon-patch.js" defer></script>
  <script src="/assets/vendor/leaflet.polylineDecorator.min.js" defer></script>
  <script src="/assets/js/amaayesh-map.min.js" type="module"></script>
  <script src="/assets/js/panel-direct-wire.js" defer></script>
  <script src="/assets/js/ama-diag.js" defer></script>
  <script src="/assets/js/amaayesh-ui-enhancements.js" defer></script>
  <script>
    (function(){
      const mapEl = document.getElementById('map');
      if (!mapEl || typeof ResizeObserver === 'undefined') return;
      const ensureMapRef = () => {
        if (!window.myLeafletMap && window.__AMA_MAP && typeof window.__AMA_MAP.invalidateSize === 'function') {
          window.myLeafletMap = window.__AMA_MAP;
        }
        window.myLeafletMap?.invalidateSize();
      };
      ensureMapRef();
      new ResizeObserver(ensureMapRef).observe(mapEl);
    })();
  </script>
  <script defer src="/assets/js/ui-prune-ctas.js"></script>
  <script src="/assets/js/header.js" defer></script>
  <script src="/assets/js/nav-prune.js" defer></script>

  <!-- ✅ Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('[SW] Registered:', registration.scope);
          })
          .catch((error) => {
            console.warn('[SW] Registration failed:', error);
          });
      });
    }
  </script>

  <!-- Statsfa Website Analytics Start -->
  <script data-host="https://statsfa.com" data-dnt="true" src="https://statsfa.com/js/script.js" id="ZwSg9rf6GA" async defer></script>
  <!-- Statsfa Website Analytics End -->
  <!-- دکمه ثبت بازخورد Porsline -->
  <a class="porsline-button-wrapper" href="#porsline-side-tab"
    onclick="clzdTiLuIp('porsline-side-tab-iframe');showSideTab()">
    بازخورد دهید
  </a>
  <script>
    // Load Porsline script immediately with async for better performance
    (function() {
      try {
        var js,q,d=document,
          gi=d.getElementById,
          ce=d.createElement,
          gt=d.getElementsByTagName,
          id="porsline-share",
          b="https://cdn.porsline.ir/static/panel/v2/statics/";
        if(!gi.call(d,id)) {
          js=ce.call(d,"script");
          js.id = id;
          js.setAttribute("data-position","right");
          js.src=b+"side-tab.js";
          js.async = true;
          js.onerror = function() {
            console.warn('Porsline script failed to load');
          };
          q=gt.call(d,"script")[0];
          q.parentNode.insertBefore(js,q);
        }
      } catch(e) {
        console.warn('Porsline initialization error:', e.message);
      }
    })();

    var clzdTiLuIp = function (ifid) {
      try {
        const el = document.getElementById(ifid);
        if (el) {
          el.fetchPriority = 'high';
          el.src = "https://survey.porsline.ir/s/zdTiLuIp#/?ac=0&ns=0";
        }
      } catch(e) {
        console.warn('Porsline iframe error:', e.message);
      }
    };
  </script>
</body>
</html>

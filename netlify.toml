[build]
  publish = "docs"
  command = "npm ci && npm run build || true && npm run verify:publish || true"
  node_version = "18"

[build.processing]
  skip_processing = true

[build.environment]
  CI = "true"

# همان دستور برای Deploy Preview تا PRها هم باندل درست داشته باشند
[context.deploy-preview]
  command = "npm ci && npm run build || true && npm run verify:publish || true"

[context.deploy-preview.environment]
  NODE_VERSION = "22"

[context.production.environment]
  # Production stays on Node 18
  NODE_VERSION = "18"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"

[[redirects]]
  from = "/agrivoltaics"
  to = "/agrivoltaics/"
  status = 301

[[redirects]]
  from = "/agrivoltaics/*"
  to = "/agrivoltaics/index.html"
  status = 200

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

# --- Ensure SPA rewrite does not catch data files ---
# If there is a catch-all like /* -> /index.html 200, keep it LAST,
# and add explicit passthrough rules above it:
[[redirects]]
from = "/amaayesh/*"
to = "/amaayesh/:splat"
status = 200
force = false

# نکته: چون publish=docs است، مسیرهای runtime از ریشه‌ی سایت هستند ("/"),
# بنابراین برای فونت‌ها "/fonts/..." درست است نه "/docs/fonts/..."
[[headers]]
for = "/fonts/vazirmatn/*"
  [headers.values]
  Access-Control-Allow-Origin = "*"
  Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/assets/images/*"
  [headers.values]
  Cache-Control = "public, max-age=31536000, immutable"
  Access-Control-Allow-Origin = "*"

# برای باندل‌های CLD چون اسم فایل ثابت است (بدون hash)، کش کوتاه بگذار
[[headers]]
for = "/assets/dist/*"
  [headers.values]
  Cache-Control = "public, max-age=600"
  Access-Control-Allow-Origin = "*"

[[headers]]
for = "/*.woff2"
  [headers.values]
  Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/assets/*"
  [headers.values]
  Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/data/amaayesh/*"
  [headers.values]
  Cache-Control = "public, max-age=900, stale-while-revalidate=60"
  Access-Control-Allow-Origin = "*"
  Access-Control-Allow-Methods = "GET,OPTIONS"
  Access-Control-Allow-Headers = "Content-Type"

# --- Data headers (GeoJSON/CSV) ---
[[headers]]
for = "/amaayesh/*.geojson"
  [headers.values]
  Cache-Control = "public, max-age=900"
  Access-Control-Allow-Origin = "*"
  Content-Type = "application/geo+json; charset=utf-8"

[[headers]]
for = "/amaayesh/*.csv"
  [headers.values]
  Cache-Control = "public, max-age=900"
  Access-Control-Allow-Origin = "*"

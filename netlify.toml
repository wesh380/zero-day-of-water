[build]
  publish = "docs"
  command = "npm ci && npm run build || true && npm run verify:publish || true"
  node_version = "18"

[build.processing]
  skip_processing = true

[build.environment]
  CI = "true"

# Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Deploy Preview ØªØ§ PRÙ‡Ø§ Ù‡Ù… Ø¨Ø§Ù†Ø¯Ù„ Ø¯Ø±Ø³Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯
[context.deploy-preview]
  command = "npm ci && npm run build || true && npm run verify:publish || true"

[context.deploy-preview.environment]
  NODE_VERSION = "22"

[context.production.environment]
  # Production stays on Node 18
  NODE_VERSION = "18"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"

[[redirects]]
  from = "/agrivoltaics"
  to = "/agrivoltaics/"
  status = 301

[[redirects]]
  from = "/agrivoltaics/*"
  to = "/agrivoltaics/index.html"
  status = 200

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

# --- Ensure SPA rewrite does not catch data files ---
# If there is a catch-all like /* -> /index.html 200, keep it LAST,
# and add explicit passthrough rules above it:
[[redirects]]
from = "/amaayesh/*"
to = "/amaayesh/:splat"
status = 200
force = false

# Ù†Ú©ØªÙ‡: Ú†ÙˆÙ† publish=docs Ø§Ø³ØªØŒ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ runtime Ø§Ø² Ø±ÛŒØ´Ù‡â€ŒÛŒ Ø³Ø§ÛŒØª Ù‡Ø³ØªÙ†Ø¯ ("/"),
# Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ† Ø¨Ø±Ø§ÛŒ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ "/fonts/..." Ø¯Ø±Ø³Øª Ø§Ø³Øª Ù†Ù‡ "/docs/fonts/..."
[[headers]]
for = "/fonts/vazirmatn/*"
  [headers.values]
  Access-Control-Allow-Origin = "*"
  Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/assets/images/*"
  [headers.values]
  Cache-Control = "public, max-age=31536000, immutable"
  Access-Control-Allow-Origin = "*"

# Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ù†Ø¯Ù„â€ŒÙ‡Ø§ÛŒ CLD Ú†ÙˆÙ† Ø§Ø³Ù… ÙØ§ÛŒÙ„ Ø«Ø§Ø¨Øª Ø§Ø³Øª (Ø¨Ø¯ÙˆÙ† hash)ØŒ Ú©Ø´ Ú©ÙˆØªØ§Ù‡ Ø¨Ú¯Ø°Ø§Ø±
[[headers]]
for = "/assets/dist/*"
  [headers.values]
  Cache-Control = "public, max-age=600"
  Access-Control-Allow-Origin = "*"

[[headers]]
for = "/*.woff2"
  [headers.values]
  Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/assets/*"
  [headers.values]
  Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/data/amaayesh/*"
  [headers.values]
  Cache-Control = "public, max-age=900, stale-while-revalidate=60"
  Access-Control-Allow-Origin = "*"
  Access-Control-Allow-Methods = "GET,OPTIONS"
  Access-Control-Allow-Headers = "Content-Type"

# --- Data headers (GeoJSON/CSV) ---
[[headers]]
for = "/amaayesh/*.geojson"
  [headers.values]
  Cache-Control = "public, max-age=900"
  Access-Control-Allow-Origin = "*"
  Content-Type = "application/geo+json; charset=utf-8"

[[headers]]
for = "/amaayesh/*.csv"
  [headers.values]
  Cache-Control = "public, max-age=900"
  Access-Control-Allow-Origin = "*"

[[redirects]]
  from = "/water/data/*"
  to = "/data/:splat"
  status = 200
  force = true

[[redirects]]
from = "/test/water-cld"
to   = "/water/cld/"
status = 301

[[headers]]
for = "/water/cld/*"
  [headers.values]
  Content-Security-Policy = "default-src 'self'; connect-src 'self' https://api.wesh360.ir; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;"
